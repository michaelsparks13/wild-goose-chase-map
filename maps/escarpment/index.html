<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffffff">
<link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
<title>Escarpment Trail Run 30K - Course Map</title>
<script src="https://unpkg.com/maplibre-gl@5.18.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@5.18.0/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/pmtiles@4.4.0/dist/pmtiles.js"></script>
<script src="https://unpkg.com/@protomaps/basemaps@5.7.0/dist/basemaps.js" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #2E7D32;
  --primary-dark: #1B5E20;
  --accent: #1B5E20;
  --bg: #ffffff;
  --bg-card: #f7f7f7;
  --bg-alt: #f2f2f2;
  --text: #222222;
  --text-secondary: #555555;
  --text-muted: #888888;
  --border: #dddddd;
  --course: #111111;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --radius: 12px;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { font-size: 16px; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  background: var(--bg-alt);
  color: var(--text);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

.header {
  background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg) 100%);
  padding: 16px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-left h1 {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text);
  letter-spacing: 0.5px;
}
.header-left .subtitle {
  font-size: 0.7rem;
  color: var(--text-secondary);
  margin-top: 2px;
}
.header-left .subtitle a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
}
.race-badge {
  background: var(--primary);
  color: #fff;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.map-wrap { position: relative; }
#map { width: 100%; height: 55vh; min-height: 300px; }

.map-overlay {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 10;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.info-badge {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 10px 14px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
}
.info-badge .label {
  font-size: 0.6rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 2px;
}
.info-badge .value {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text);
}

.toggle-btns {
  position: absolute;
  top: 12px;
  right: 12px;
  z-index: 10;
  display: flex;
  gap: 6px;
}
.toggle-btn {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 0.7rem;
  font-weight: 600;
  font-family: inherit;
  color: var(--text-secondary);
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: all 0.2s;
}
.toggle-btn:hover { border-color: var(--primary); color: var(--text); }
.toggle-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

.stats-section {
  background: var(--bg-card);
  padding: 20px;
  border-bottom: 1px solid var(--border);
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  max-width: 600px;
  margin: 0 auto;
}
.stat-card {
  text-align: center;
  padding: 12px 8px;
  background: var(--bg-alt);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.stat-card .value {
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--primary);
}
.stat-card .label {
  font-size: 0.6rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-top: 4px;
}

.profile-section {
  background: var(--bg-alt);
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}
.profile-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.profile-header h3 {
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}
.profile-stats {
  display: flex;
  gap: 16px;
  font-size: 0.7rem;
  color: var(--text-secondary);
}
.profile-stats .val { font-weight: 600; color: var(--primary); }
#profileCanvas {
  width: 100%;
  height: 100px;
  display: block;
  background: var(--bg-card);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.course-info {
  padding: 20px;
  background: var(--bg-card);
  border-top: 1px solid var(--border);
}
.course-info h3 {
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}
.course-description {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.7;
}
.course-description strong {
  color: var(--text);
  font-weight: 600;
}

.footer {
  text-align: center;
  padding: 20px;
  font-size: 0.65rem;
  color: var(--text-muted);
  border-top: 1px solid var(--border);
}
.footer a { color: var(--primary); text-decoration: none; }

/* Map customization */
.maplibregl-popup-content {
  background: #fff !important;
  color: var(--text) !important;
  border-radius: var(--radius) !important;
  padding: 12px 16px !important;
  box-shadow: 0 2px 12px rgba(0,0,0,0.15) !important;
  font-family: inherit !important;
  font-size: 0.85rem !important;
  border: 1px solid var(--border) !important;
}
.maplibregl-popup-tip { border-top-color: #fff !important; }
.maplibregl-popup-close-button { color: var(--text-muted) !important; font-size: 18px !important; }
.maplibregl-ctrl-attrib { font-size: 9px !important; }
.maplibregl-ctrl-group { border-radius: 8px !important; overflow: hidden; }

.start-marker, .aid-marker {
  width: 32px;
  height: 32px;
  cursor: pointer;
}
.start-marker svg, .aid-marker svg {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
}

/* View tabs */
.view-tabs {
  display: flex;
  gap: 4px;
  background: var(--bg-alt);
  padding: 3px;
  border-radius: 8px;
}
.view-tab {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  background: transparent;
  font-family: inherit;
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
}
.view-tab:active { transform: scale(0.96); }
.view-tab.active {
  background: var(--bg);
  color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.view { display: none; }
.view.active { display: block; }

/* Simulator */
.sim-container { background: var(--bg); display: flex; flex-direction: column; }
.sim-panel { display: contents; }
/* Mobile order */
.sim-panel .goal-time-bar { order: 1; }
.sim-visual { order: 2; }
.sim-panel .scrubber { order: 3; }
.sim-panel .sim-clock { order: 4; }
.sim-panel .sim-stats { order: 5; }

/* Course map canvas */
.course-map-wrap { position: relative; background: #e8ede9; border-bottom: 1px solid var(--border); }
#courseMapCanvas { width: 100%; height: 260px; display: block; }
.runner-info-overlay {
  position: absolute; top: 12px; left: 12px; pointer-events: none;
}
.runner-ele {
  font-size: 1.8rem; font-weight: 700; color: #222; line-height: 1;
  text-shadow: 0 1px 3px rgba(255,255,255,0.7);
}
.runner-meta { font-size: 0.7rem; color: #555; margin-top: 2px; }

/* Sim elevation profile */
.sim-profile-wrap { position: relative; background: #e8ede9; }
#simProfileCanvas { width: 100%; height: 40px; display: block; }

/* Scrubber */
.scrubber {
  background: var(--bg); padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}
.scrub-row { display: flex; align-items: center; gap: 12px; }
.play-btn {
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--primary); border: none; color: #fff;
  cursor: pointer; display: flex; align-items: center;
  justify-content: center; font-size: 14px; flex-shrink: 0;
  transition: all 0.15s;
}
.play-btn:active { transform: scale(0.95); background: var(--primary-dark); }
.scrub-track { flex: 1; position: relative; height: 36px; cursor: pointer; }
.scrub-bg {
  position: absolute; top: 14px; left: 0; right: 0; height: 8px;
  background: var(--bg-alt); border-radius: 4px; overflow: hidden;
}
.scrub-fill {
  position: absolute; top: 0; left: 0; height: 100%;
  background: var(--primary); opacity: 0.3; border-radius: 4px 0 0 4px;
}
.scrub-handle {
  position: absolute; top: 8px; width: 20px; height: 20px;
  background: var(--primary); border-radius: 50%; transform: translateX(-50%);
  box-shadow: 0 2px 6px rgba(46,125,50,0.4); pointer-events: none;
}
.speed-btns { display: flex; gap: 4px; flex-shrink: 0; }
.speed-btn {
  padding: 6px 10px; border-radius: 6px; background: var(--bg-alt);
  border: 1px solid var(--border); color: var(--text-muted);
  font-family: inherit; font-size: 0.7rem; font-weight: 600;
  cursor: pointer; transition: all 0.15s;
}
.speed-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

/* Goal time */
.goal-time-bar {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 16px; background: var(--bg);
  border-bottom: 1px solid var(--border); flex-wrap: wrap;
}
.goal-label {
  font-size: 0.65rem; font-weight: 600; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px;
}
.goal-inputs { display: flex; align-items: center; gap: 4px; }
.goal-input {
  width: 48px; padding: 8px 4px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--bg-alt);
  color: var(--text); font-family: inherit; font-size: 1rem;
  font-weight: 600; text-align: center; outline: none;
}
.goal-input:focus { border-color: var(--primary); }
.goal-colon { font-size: 1.2rem; font-weight: 700; color: var(--text-muted); }
.goal-pace { font-size: 0.8rem; color: var(--text-secondary); margin-left: auto; }
.goal-pace strong { color: var(--text); font-weight: 600; }

/* Sim stats */
.sim-stats {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 1px; background: var(--border);
}
.sim-stat {
  background: var(--bg); padding: 12px 8px; text-align: center;
}
.sim-stat .val { font-size: 1.1rem; font-weight: 700; color: var(--text); }
.sim-stat .label {
  font-size: 0.6rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;
}

/* Clock */
.sim-clock {
  background: var(--bg); padding: 16px; text-align: center;
  border-bottom: 1px solid var(--border);
}
.clock-time { font-size: 2rem; font-weight: 700; color: var(--text); letter-spacing: 1px; }
.clock-label {
  font-size: 0.6rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px; margin-top: 2px;
}

@media (max-width: 600px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .stat-card .value { font-size: 1.2rem; }
  #map { height: 45vh; }
}
@media (min-width: 768px) {
  #courseMapCanvas { height: 300px; }
  #simProfileCanvas { height: 50px; }
  .sim-stats { grid-template-columns: repeat(6, 1fr); }
}
@media (min-width: 1024px) {
  .page-shell { max-width: 960px; margin: 0 auto; min-height: 100vh; background: var(--bg-alt); box-shadow: 0 0 1px rgba(0,0,0,0.1); }
  .sim-container { flex-direction: row; height: calc(100vh - 52px); overflow: hidden; }
  .sim-panel {
    display: flex; flex-direction: column;
    width: 360px; flex-shrink: 0;
    overflow-y: auto; border-right: 1px solid var(--border);
  }
  .sim-panel .sim-clock { padding: 12px 16px; }
  .sim-panel .sim-clock .clock-time { font-size: 1.4rem; }
  .sim-panel .sim-clock .clock-label { font-size: 0.55rem; }
  .sim-panel .sim-stats { grid-template-columns: repeat(3, 1fr); }
  .sim-visual {
    flex: 1; min-width: 0;
    display: flex; flex-direction: column;
  }
  .sim-visual .course-map-wrap { flex: 1; min-height: 0; }
  #courseMapCanvas { height: 100%; }
  #simProfileCanvas { height: 60px; }
}
@media (min-width: 1440px) {
  .page-shell { max-width: 1080px; }
  .sim-panel { width: 400px; }
}
</style>
</head>
<body>
<div class="page-shell">

<header class="header">
  <div class="header-left">
    <h1>Escarpment Trail Run 30K</h1>
    <div class="subtitle">July 26, 2026 &bull; <a href="https://escarpmenttrail.com" target="_blank">Escarpment Trail Run</a></div>
  </div>
  <div class="view-tabs">
    <button class="view-tab active" data-view="map" onclick="switchView('map')">Map</button>
    <button class="view-tab" data-view="sim" onclick="switchView('sim')">Simulator</button>
  </div>
</header>

<div id="mapView" class="view active">

<div class="map-wrap">
  <div id="map"></div>
  <div class="map-overlay">
    <div class="info-badge">
      <div class="label">Start / Finish</div>
      <div class="value">Windham &#8594; Haines Falls</div>
    </div>
  </div>
  <div class="toggle-btns">
    <button class="toggle-btn active" id="courseBtn">Course</button>
    <button class="toggle-btn" id="trailBtn">Park Trails</button>
    <button class="toggle-btn" id="aidBtn">Aid Stations</button>
    <button class="toggle-btn" id="terrainBtn">3D</button>
  </div>
</div>

<section class="stats-section">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="value">18.6</div>
      <div class="label">Miles</div>
    </div>
    <div class="stat-card">
      <div class="value">~4,800</div>
      <div class="label">Elev Gain (ft)</div>
    </div>
    <div class="stat-card">
      <div class="value">6 hrs</div>
      <div class="label">Cutoff</div>
    </div>
    <div class="stat-card">
      <div class="value">Point-to-Point</div>
      <div class="label">Course Type</div>
    </div>
  </div>
</section>

<section class="profile-section">
  <div class="profile-header">
    <h3>Elevation Profile</h3>
    <div class="profile-stats">
      <span>Gain: <span class="val">~4,800 ft</span></span>
      <span>High: <span class="val">3,930 ft</span></span>
    </div>
  </div>
  <canvas id="profileCanvas"></canvas>
</section>

<section class="course-info">
  <h3>Course Description</h3>
  <div class="course-description">
    <p>The <strong>Escarpment Trail Run</strong> is a legendary 30K point-to-point race through the heart of the <strong>Catskill Mountains</strong>. The course follows the rugged Escarpment Trail from <strong>Windham to Haines Falls</strong>, traversing multiple peaks above 3,500 feet with breathtaking views of the Hudson Valley. Known as one of the toughest trail races in the Northeast, runners face relentless climbs, technical rocky descents, and over <strong>4,800 feet of elevation gain</strong> across 18.6 miles.</p>
  </div>
</section>

</div><!-- end mapView -->

<div id="simView" class="view">
  <div class="sim-container">
    <div class="sim-panel">
      <div class="goal-time-bar">
        <span class="goal-label">Goal Time</span>
        <div class="goal-inputs">
          <input type="number" class="goal-input" id="goalHrs" min="0" max="48" value="4" onchange="updateGoalTime()" onclick="this.select()">
          <span class="goal-colon">:</span>
          <input type="number" class="goal-input" id="goalMins" min="0" max="59" value="0" onchange="updateGoalTime()" onclick="this.select()">
        </div>
        <div class="goal-pace" id="goalPace">Avg pace: <strong>12:54 /mi</strong></div>
      </div>

      <div class="scrubber">
        <div class="scrub-row">
          <button class="play-btn" id="playBtn" onclick="togglePlay()">&#9654;</button>
          <div class="scrub-track" id="scrubTrack">
            <div class="scrub-bg">
              <div class="scrub-fill" id="scrubFill"></div>
            </div>
            <div class="scrub-handle" id="scrubHandle"></div>
          </div>
          <div class="speed-btns">
            <button class="speed-btn active" onclick="setSpeed(1,this)">1x</button>
            <button class="speed-btn" onclick="setSpeed(2,this)">2x</button>
            <button class="speed-btn" onclick="setSpeed(4,this)">4x</button>
          </div>
        </div>
      </div>

      <div class="sim-clock">
        <div class="clock-time" id="clockTime">9:00 AM</div>
        <div class="clock-label">Current Time (Race starts 9:00 AM)</div>
        <div style="margin-top:8px;font-size:0.8rem;color:var(--text-secondary)">Finish: <strong id="finishTime" style="color:var(--primary)">1:00 PM</strong></div>
      </div>

      <div class="sim-stats">
        <div class="sim-stat"><div class="val" id="statDist">0.0</div><div class="label">Miles</div></div>
        <div class="sim-stat"><div class="val" id="statEle">0</div><div class="label">Elevation (ft)</div></div>
        <div class="sim-stat"><div class="val" id="statGain">0</div><div class="label">Gain (ft)</div></div>
        <div class="sim-stat"><div class="val" id="statGrade">0%</div><div class="label">Grade</div></div>
        <div class="sim-stat"><div class="val" id="statPace">--:--</div><div class="label">Pace /mi</div></div>
        <div class="sim-stat"><div class="val" id="statPct">0%</div><div class="label">Complete</div></div>
      </div>
    </div>

    <div class="sim-visual">
      <div class="course-map-wrap">
        <canvas id="courseMapCanvas"></canvas>
        <div class="runner-info-overlay">
          <div class="runner-ele" id="runnerDist">Mile 0.0</div>
          <div class="runner-meta" id="runnerMeta">1,772 ft &middot; Starting</div>
        </div>
      </div>
      <div class="sim-profile-wrap">
        <canvas id="simProfileCanvas"></canvas>
      </div>
    </div>
  </div>
</div><!-- end simView -->

<footer class="footer">
  Escarpment Trail Run &bull; <a href="https://escarpmenttrail.com" target="_blank">escarpmenttrail.com</a>
  <br>Interactive map powered by MapLibre
</footer>
</div><!-- .page-shell -->

<script>
const protocol = new pmtiles.Protocol();
maplibregl.addProtocol('pmtiles', protocol.tile);

const PMTILES_URL = 'pmtiles://https://pub-e494904da8db4a209e8229adcd8b63f9.r2.dev/basemap.pmtiles';

const BASEMAP_STYLE = {
  version: 8,
  glyphs: 'https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf',
  sprite: 'https://protomaps.github.io/basemaps-assets/sprites/v4/light',
  sources: {
    protomaps: {
      type: 'vector',
      url: PMTILES_URL,
      attribution: '<a href="https://protomaps.com">Protomaps</a> &copy; <a href="https://openstreetmap.org">OpenStreetMap</a>'
    },
    'hillshade-dem': {
      type: 'raster-dem',
      tiles: ['https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'],
      tileSize: 256, maxzoom: 15, encoding: 'terrarium'
    }
  },
  layers: [...basemaps.layers('protomaps', {
    ...basemaps.namedFlavor('light'),
    background: '#c5dcb4',
    earth: '#c5dcb4',
    park_a: '#a5cc8e',
    park_b: '#a5cc8e',
    wood_a: '#8ecc7a',
    wood_b: '#8ecc7a',
    scrub_a: '#a3d487',
    scrub_b: '#a3d487',
    water: '#80deea',
    sand: '#d6e28d',
    beach: '#d6e28d',
    glacier: '#edf3f8'
  }, { lang: 'en' }), {
    id: 'hillshade', type: 'hillshade', source: 'hillshade-dem',
    paint: {
      'hillshade-exaggeration': 0.3,
      'hillshade-shadow-color': '#5a5a5a',
      'hillshade-highlight-color': '#ffffff',
      'hillshade-accent-color': '#4a8f29'
    }
  }]
};

const START_COORDS = [-74.18962, 42.31287];
const FINISH_COORDS = [-74.03642, 42.19621];

// Course data - truncated to 321 points (18.6 miles of the 23.2 mile GPX)
const COURSE_COORDS = [
  [-74.18962, 42.31287],[-74.18862, 42.31253],[-74.18808, 42.31183],[-74.18742, 42.31114],[-74.18716, 42.31059],
  [-74.18606, 42.31059],[-74.18499, 42.31042],[-74.18395, 42.31011],[-74.183, 42.30967],[-74.18193, 42.30951],
  [-74.18085, 42.30935],[-74.17976, 42.30917],[-74.1787, 42.30894],[-74.17764, 42.30871],[-74.17743, 42.30812],
  [-74.17709, 42.30793],[-74.17604, 42.3082],[-74.17617, 42.30761],[-74.17524, 42.30805],[-74.17427, 42.30831],
  [-74.17471, 42.30761],[-74.1754, 42.30696],[-74.17471, 42.30663],[-74.17364, 42.30679],[-74.17257, 42.30677],
  [-74.17173, 42.30726],[-74.17089, 42.30777],[-74.16998, 42.30821],[-74.16898, 42.30814],[-74.16797, 42.30803],
  [-74.167, 42.30841],[-74.16602, 42.30863],[-74.16524, 42.30906],[-74.16425, 42.30929],[-74.16322, 42.309],
  [-74.16213, 42.30897],[-74.16118, 42.3093],[-74.16021, 42.30965],[-74.1591, 42.30978],[-74.15799, 42.30975],
  [-74.15688, 42.30965],[-74.15586, 42.30956],[-74.1548, 42.30942],[-74.15394, 42.3089],[-74.15349, 42.30816],
  [-74.15299, 42.30747],[-74.15191, 42.30749],[-74.15087, 42.30743],[-74.14995, 42.30766],[-74.14967, 42.30842],
  [-74.14985, 42.30914],[-74.14974, 42.30994],[-74.14938, 42.31071],[-74.14863, 42.3113],[-74.14795, 42.31193],
  [-74.14724, 42.31256],[-74.14633, 42.31298],[-74.14582, 42.31368],[-74.14513, 42.31431],[-74.14432, 42.31473],
  [-74.14328, 42.31495],[-74.14245, 42.31484],[-74.14176, 42.31446],[-74.14086, 42.31417],[-74.13991, 42.31388],
  [-74.13881, 42.31389],[-74.13787, 42.31358],[-74.13717, 42.31312],[-74.13626, 42.31269],[-74.13538, 42.31222],
  [-74.13477, 42.31158],[-74.13446, 42.31082],[-74.1345, 42.31],[-74.13474, 42.30924],[-74.13429, 42.3085],
  [-74.1335, 42.30795],[-74.13265, 42.30745],[-74.13182, 42.307],[-74.13076, 42.30702],[-74.12995, 42.30649],
  [-74.12919, 42.30595],[-74.12889, 42.30518],[-74.12859, 42.30441],[-74.12812, 42.30369],[-74.12734, 42.30338],
  [-74.12628, 42.30357],[-74.12525, 42.3039],[-74.12417, 42.30414],[-74.12315, 42.30396],[-74.12238, 42.30346],
  [-74.12156, 42.30349],[-74.1214, 42.30288],[-74.12102, 42.30216],[-74.12038, 42.30149],[-74.11944, 42.3011],
  [-74.11842, 42.3008],[-74.11753, 42.30046],[-74.11646, 42.3002],[-74.11539, 42.30029],[-74.11445, 42.30068],
  [-74.11427, 42.30115],[-74.11371, 42.30068],[-74.11281, 42.30047],[-74.11173, 42.30061],[-74.11064, 42.30067],
  [-74.1097, 42.30062],[-74.10913, 42.30069],[-74.10819, 42.30074],[-74.10726, 42.30051],[-74.10637, 42.30011],
  [-74.10639, 42.29981],[-74.10558, 42.29947],[-74.10466, 42.29899],[-74.10399, 42.29846],[-74.10295, 42.29821],
  [-74.10222, 42.29767],[-74.10133, 42.29735],[-74.10037, 42.29716],[-74.09972, 42.29652],[-74.09948, 42.29573],
  [-74.09979, 42.29495],[-74.10002, 42.29413],[-74.09998, 42.29332],[-74.10056, 42.29264],[-74.10122, 42.29197],
  [-74.10159, 42.29121],[-74.10166, 42.29042],[-74.10146, 42.28963],[-74.10128, 42.28882],[-74.10079, 42.28816],
  [-74.10004, 42.28761],[-74.09929, 42.28702],[-74.09861, 42.2864],[-74.09865, 42.28566],[-74.09929, 42.28501],
  [-74.09964, 42.28423],[-74.09946, 42.28342],[-74.09885, 42.28276],[-74.09842, 42.28216],[-74.09801, 42.28141],
  [-74.09772, 42.28061],[-74.09728, 42.2799],[-74.09758, 42.27917],[-74.09821, 42.27855],[-74.09777, 42.27803],
  [-74.09751, 42.27726],[-74.09783, 42.27649],[-74.09803, 42.27572],[-74.09829, 42.27502],[-74.09828, 42.27421],
  [-74.09877, 42.27356],[-74.09899, 42.27277],[-74.09898, 42.27209],[-74.09875, 42.27141],[-74.09876, 42.27067],
  [-74.09916, 42.2701],[-74.09941, 42.26987],[-74.10017, 42.26945],[-74.10088, 42.26924],[-74.10177, 42.26881],
  [-74.10269, 42.26902],[-74.10343, 42.26881],[-74.10366, 42.26829],[-74.10446, 42.26788],[-74.10418, 42.26747],
  [-74.10372, 42.26681],[-74.10322, 42.26619],[-74.10252, 42.26569],[-74.10167, 42.26556],[-74.1007, 42.26532],
  [-74.09975, 42.26493],[-74.09889, 42.26445],[-74.09803, 42.26395],[-74.09709, 42.26352],[-74.09607, 42.26325],
  [-74.09502, 42.26313],[-74.09391, 42.26312],[-74.09285, 42.26286],[-74.09201, 42.26238],[-74.09159, 42.2616],
  [-74.09116, 42.26086],[-74.09103, 42.26007],[-74.09067, 42.25932],[-74.08988, 42.25921],[-74.08884, 42.25893],
  [-74.08773, 42.25874],[-74.08662, 42.25861],[-74.08558, 42.25841],[-74.08487, 42.25778],[-74.08421, 42.25714],
  [-74.08353, 42.25648],[-74.08304, 42.25578],[-74.08302, 42.25499],[-74.08342, 42.25422],[-74.08376, 42.25344],
  [-74.08372, 42.25265],[-74.08315, 42.25195],[-74.08206, 42.25196],[-74.0811, 42.25231],[-74.08038, 42.25182],
  [-74.07981, 42.25141],[-74.07917, 42.25162],[-74.07888, 42.251],[-74.0793, 42.25024],[-74.07927, 42.24977],
  [-74.07834, 42.24995],[-74.0773, 42.25006],[-74.07626, 42.24977],[-74.07549, 42.24923],[-74.07539, 42.24859],
  [-74.07511, 42.2479],[-74.07451, 42.2472],[-74.07389, 42.24655],[-74.07361, 42.24575],[-74.07301, 42.24508],
  [-74.07231, 42.2445],[-74.07168, 42.24383],[-74.07148, 42.24299],[-74.07102, 42.24225],[-74.07069, 42.24145],
  [-74.07031, 42.24069],[-74.07025, 42.2399],[-74.07031, 42.23911],[-74.07068, 42.23842],[-74.07062, 42.23812],
  [-74.0701, 42.2375],[-74.07016, 42.23688],[-74.07048, 42.23631],[-74.07016, 42.23557],[-74.07042, 42.23484],
  [-74.07039, 42.23402],[-74.07002, 42.23323],[-74.06955, 42.2325],[-74.06909, 42.23174],[-74.06844, 42.2311],
  [-74.0678, 42.23041],[-74.06711, 42.22976],[-74.06655, 42.22903],[-74.06586, 42.2284],[-74.06544, 42.22765],
  [-74.06504, 42.22693],[-74.06457, 42.22625],[-74.06472, 42.22563],[-74.06578, 42.22534],[-74.06552, 42.22487],
  [-74.06441, 42.22487],[-74.06367, 42.22495],[-74.06302, 42.22467],[-74.06206, 42.22436],[-74.0614, 42.22375],
  [-74.06054, 42.22328],[-74.05959, 42.22281],[-74.05881, 42.22225],[-74.05785, 42.22188],[-74.05693, 42.22159],
  [-74.05596, 42.22123],[-74.05519, 42.2206],[-74.05478, 42.21983],[-74.05445, 42.21906],[-74.05358, 42.21854],
  [-74.05294, 42.21833],[-74.05192, 42.21825],[-74.05092, 42.21858],[-74.04994, 42.21881],[-74.04891, 42.21902],
  [-74.04784, 42.21923],[-74.04675, 42.21932],[-74.04591, 42.21879],[-74.04518, 42.21867],[-74.04442, 42.21919],
  [-74.04369, 42.21975],[-74.04329, 42.2197],[-74.04268, 42.22028],[-74.04194, 42.22042],[-74.04097, 42.22019],
  [-74.0404, 42.21999],[-74.03958, 42.21956],[-74.03975, 42.21892],[-74.03996, 42.21858],[-74.03996, 42.21807],
  [-74.03907, 42.21755],[-74.03825, 42.21698],[-74.03718, 42.21672],[-74.03643, 42.21722],[-74.03585, 42.21714],
  [-74.03563, 42.21637],[-74.03543, 42.21557],[-74.03563, 42.21494],[-74.03516, 42.21462],[-74.03478, 42.21393],
  [-74.03435, 42.21461],[-74.03374, 42.214],[-74.03377, 42.2132],[-74.03345, 42.21272],[-74.03237, 42.21266],
  [-74.03177, 42.21233],[-74.03131, 42.21161],[-74.03092, 42.21085],[-74.03064, 42.21006],[-74.03097, 42.20932],
  [-74.03123, 42.20854],[-74.03107, 42.20781],[-74.03128, 42.207],[-74.03118, 42.20624],[-74.0311, 42.20542],
  [-74.03056, 42.20472],[-74.03024, 42.20394],[-74.03038, 42.20323],[-74.03038, 42.20245],[-74.02954, 42.20214],
  [-74.02986, 42.2015],[-74.0305, 42.20086],[-74.031, 42.2002],[-74.03121, 42.19942],[-74.03195, 42.19883],
  [-74.03275, 42.19835],[-74.03367, 42.19786],[-74.03459, 42.19735],[-74.03477, 42.19656],[-74.0354, 42.19612],
  [-74.03642, 42.19621]
];

// Elevation data (meters, sampled from GPX) - truncated to 321 points
const ELEVATIONS = [
  540, 541, 541, 546, 553, 562, 565, 573, 583, 592, 598, 607, 617, 627, 638, 650, 659, 666, 672, 675,
  688, 697, 706, 710, 721, 740, 752, 761, 773, 781, 788, 797, 812, 822, 827, 828, 835, 844, 845, 847,
  846, 860, 869, 885, 900, 911, 928, 930, 943, 959, 983, 994, 1013, 1021, 1031, 1042, 1042, 1053, 1067, 1070,
  1074, 1058, 1045, 1028, 1007, 994, 982, 965, 949, 936, 936, 932, 933, 928, 932, 937, 930, 905, 887, 886,
  903, 921, 925, 912, 899, 900, 906, 907, 903, 917, 931, 934, 935, 931, 930, 924, 929, 930, 920, 903,
  895, 886, 863, 847, 843, 851, 874, 889, 907, 907, 909, 912, 912, 916, 930, 937, 939, 941, 935, 923,
  921, 924, 925, 921, 917, 913, 909, 914, 913, 898, 893, 894, 899, 905, 911, 908, 905, 904, 904, 904,
  904, 903, 903, 896, 890, 884, 875, 873, 879, 891, 918, 944, 963, 960, 969, 985, 997, 1023, 1047, 1077,
  1099, 1129, 1169, 1189, 1198, 1191, 1183, 1166, 1135, 1097, 1072, 1048, 1036, 1037, 1034, 1023, 1017, 1009, 1011, 1009,
  1012, 1021, 1034, 1039, 1033, 1027, 1022, 1020, 1016, 1015, 1019, 1015, 1002, 990, 975, 965, 960, 963, 962, 930,
  895, 872, 855, 842, 827, 818, 802, 779, 762, 776, 797, 820, 838, 848, 855, 855, 852, 847, 839, 834,
  830, 832, 844, 863, 875, 898, 916, 941, 941, 954, 963, 962, 963, 965, 961, 963, 963, 967, 969, 983,
  1003, 1028, 1037, 1037, 1036, 1037, 1035, 1019, 1004, 998, 985, 980, 977, 970, 964, 956, 953, 954, 953, 955,
  954, 961, 955, 950, 942, 941, 951, 959, 954, 944, 936, 936, 929, 922, 917, 909, 885, 864, 844, 828,
  825, 828, 832, 831, 827, 828, 826, 823, 818, 802, 792, 790, 786, 780, 754, 743, 744, 749, 741, 749,
  757, 736, 743, 734, 731, 729, 728, 718, 706, 674, 680, 687, 680, 666, 663, 659, 653, 652, 652, 657,
  665
];

const COURSE = {
  type: 'Feature',
  properties: {
    name: 'Escarpment Trail Run 30K',
    distance_mi: 18.6
  },
  geometry: {
    type: 'LineString',
    coordinates: COURSE_COORDS
  }
};

const TRAILS_DATA = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"Escarpment Trail","blaze":"red"},"geometry":{"type":"LineString","coordinates":[[-74.18912,42.31268],[-74.18927,42.31273],[-74.18855,42.31239],[-74.18882,42.31261],[-74.18977,42.31285],[-74.18941,42.31283],[-74.18836,42.31215],[-74.18723,42.31091],[-74.18734,42.31055],[-74.18633,42.31061],[-74.1851,42.31047],[-74.18295,42.30963],[-74.18055,42.30929],[-74.17736,42.30864],[-74.17726,42.30842],[-74.1776,42.30783],[-74.17754,42.30774],[-74.17578,42.30817],[-74.17621,42.30771],[-74.17609,42.30764],[-74.17475,42.30824],[-74.17423,42.30826],[-74.17426,42.30803],[-74.17503,42.30745],[-74.1755,42.30683],[-74.17543,42.30667],[-74.17518,42.30661],[-74.17389,42.30675],[-74.17255,42.30672],[-74.1701,42.30814],[-74.16953,42.3083],[-74.16924,42.30827],[-74.1687,42.30794],[-74.16795,42.30794],[-74.16685,42.30846],[-74.16609,42.30853],[-74.16545,42.30906],[-74.16389,42.30924],[-74.16239,42.30886],[-74.16132,42.30921],[-74.16065,42.30957],[-74.15963,42.30969],[-74.15812,42.30967],[-74.15644,42.30943],[-74.15538,42.30953],[-74.15474,42.30936],[-74.15394,42.30892],[-74.1531,42.30757],[-74.15285,42.30742],[-74.15134,42.30752],[-74.15045,42.30734],[-74.15015,42.3074],[-74.14972,42.30782],[-74.1496,42.30844],[-74.14989,42.30878],[-74.14991,42.3092],[-74.14952,42.31039],[-74.14905,42.31102],[-74.1483,42.31152],[-74.14744,42.31239],[-74.14629,42.31296],[-74.14573,42.31372],[-74.14521,42.31415],[-74.14502,42.31455],[-74.14294,42.31492],[-74.14254,42.31479],[-74.14229,42.31454],[-74.14175,42.31442],[-74.14157,42.31419],[-74.14102,42.31416],[-74.14026,42.31385],[-74.13831,42.3138],[-74.13721,42.31337],[-74.13714,42.31315],[-74.13578,42.31232],[-74.13508,42.3121],[-74.13443,42.31088],[-74.13439,42.31044],[-74.1348,42.30938],[-74.13461,42.30871],[-74.13387,42.30801],[-74.13211,42.30703],[-74.13185,42.30695],[-74.13089,42.30703],[-74.1297,42.30626],[-74.12904,42.30562],[-74.12868,42.30456],[-74.12799,42.30341],[-74.12703,42.30333],[-74.12599,42.30356],[-74.1252,42.3039],[-74.12405,42.30403],[-74.12323,42.30394],[-74.12268,42.30371],[-74.12214,42.3032],[-74.12174,42.30342],[-74.12134,42.30342],[-74.1214,42.30272],[-74.1213,42.30242],[-74.12061,42.30154],[-74.11831,42.30058],[-74.11639,42.30007],[-74.11558,42.30011],[-74.11428,42.30078],[-74.11411,42.30098],[-74.11427,42.30122],[-74.11381,42.30106],[-74.11369,42.30061],[-74.11348,42.30047],[-74.10972,42.30063],[-74.10923,42.30043],[-74.10911,42.30069],[-74.10795,42.30075],[-74.10623,42.30004],[-74.10574,42.29959],[-74.10475,42.29906],[-74.10436,42.29851],[-74.10277,42.29817],[-74.1019,42.29736],[-74.10071,42.29729],[-74.10023,42.29709],[-74.09959,42.29638],[-74.09947,42.2955],[-74.09988,42.29475],[-74.09998,42.29334],[-74.10158,42.29163],[-74.10168,42.29052],[-74.10131,42.28906],[-74.10092,42.28831],[-74.10007,42.28771],[-74.09848,42.28626],[-74.09852,42.28592],[-74.09939,42.285],[-74.09961,42.2842],[-74.09936,42.28344],[-74.09858,42.28266],[-74.09771,42.28072],[-74.09725,42.28004],[-74.0972,42.27955],[-74.09813,42.27872],[-74.09821,42.27844],[-74.09759,42.27798],[-74.0975,42.2772],[-74.09784,42.27664],[-74.09781,42.27613],[-74.09826,42.27536],[-74.09827,42.27431],[-74.09868,42.27388],[-74.09905,42.27272],[-74.09885,42.27178],[-74.09866,42.27148],[-74.09872,42.2708],[-74.09907,42.27055],[-74.09914,42.27],[-74.09974,42.2696],[-74.10024,42.26945],[-74.10064,42.26954],[-74.10144,42.26891],[-74.10193,42.26877],[-74.10261,42.26902],[-74.1031,42.26903],[-74.10364,42.26858],[-74.10364,42.2683],[-74.10416,42.26821],[-74.10464,42.26774],[-74.10372,42.26712],[-74.10363,42.26668],[-74.10313,42.26614],[-74.10243,42.26571],[-74.10185,42.26571],[-74.10053,42.26529],[-74.09723,42.26359],[-74.09581,42.26314],[-74.09364,42.26299],[-74.09211,42.26258],[-74.09096,42.26065],[-74.09097,42.25975],[-74.09061,42.25933],[-74.08806,42.25868],[-74.08628,42.25853],[-74.08518,42.25821],[-74.08361,42.25652],[-74.08316,42.25619],[-74.08305,42.25591],[-74.0829,42.25516],[-74.08323,42.25436],[-74.08363,42.25383],[-74.08387,42.25295],[-74.08324,42.25199],[-74.08261,42.25183],[-74.08107,42.25226],[-74.0807,42.25215],[-74.08025,42.25172],[-74.08001,42.25175],[-74.07959,42.25122],[-74.07904,42.2516],[-74.07886,42.25099],[-74.07934,42.25021],[-74.07963,42.25002],[-74.07927,42.24975],[-74.079,42.24966],[-74.07806,42.25001],[-74.07743,42.25009],[-74.07618,42.24971],[-74.07538,42.24913],[-74.07528,42.2489],[-74.0754,42.24861],[-74.07507,42.24834],[-74.07509,42.24788],[-74.07436,42.24697],[-74.07393,42.24664],[-74.07349,42.24548],[-74.07241,42.24471],[-74.07173,42.24396],[-74.07155,42.24356],[-74.07151,42.24291],[-74.07105,42.24222],[-74.07086,42.2416],[-74.07053,42.24115],[-74.07027,42.24051],[-74.07014,42.23933],[-74.07023,42.2387],[-74.07089,42.23803],[-74.0705,42.23802],[-74.07022,42.23786],[-74.07007,42.23756],[-74.07033,42.23732],[-74.0701,42.23685],[-74.07018,42.23657],[-74.0704,42.23648],[-74.07043,42.23626],[-74.07011,42.23548],[-74.07044,42.2348],[-74.07046,42.23448],[-74.07005,42.23315],[-74.06947,42.23237],[-74.06905,42.23154],[-74.06848,42.23111],[-74.06576,42.22826],[-74.06522,42.22713],[-74.06459,42.22623],[-74.0647,42.22563],[-74.06599,42.22524],[-74.066,42.22503],[-74.06587,42.22493],[-74.0643,42.22483],[-74.06364,42.22513],[-74.06359,42.22485],[-74.0633,42.2245],[-74.06272,42.22465],[-74.06226,42.22447],[-74.06138,42.22367],[-74.05964,42.22282],[-74.05885,42.22219],[-74.05586,42.22111],[-74.05518,42.22042],[-74.05462,42.21909],[-74.05431,42.21866],[-74.05332,42.21832],[-74.05178,42.21827],[-74.0506,42.21879],[-74.05003,42.21874],[-74.04809,42.21919],[-74.04685,42.21926],[-74.04652,42.21917],[-74.04549,42.21839],[-74.04505,42.2188],[-74.044,42.21933],[-74.04374,42.2197],[-74.04325,42.21984],[-74.04235,42.22057],[-74.04204,42.2204],[-74.04151,42.22041],[-74.04088,42.22012],[-74.04065,42.21982],[-74.04024,42.21999],[-74.04002,42.2199],[-74.03958,42.21947],[-74.03946,42.21906],[-74.03984,42.21891],[-74.04022,42.21893],[-74.04001,42.21856],[-74.0402,42.21837],[-74.03991,42.21794],[-74.03838,42.21697],[-74.03756,42.2167],[-74.03692,42.21667],[-74.03672,42.21675],[-74.03624,42.21739],[-74.0361,42.21748],[-74.03591,42.21741],[-74.03578,42.21644],[-74.03551,42.21587],[-74.03556,42.21522],[-74.03536,42.21487],[-74.03539,42.21468],[-74.03501,42.21443],[-74.03492,42.21397],[-74.03476,42.21388],[-74.03466,42.21425],[-74.03436,42.21457],[-74.03415,42.21457],[-74.03379,42.21388],[-74.03376,42.2134],[-74.03396,42.21285],[-74.03378,42.2127],[-74.03294,42.21257],[-74.03213,42.21274],[-74.03124,42.21149],[-74.03072,42.20999],[-74.03136,42.20827],[-74.03133,42.20793],[-74.03112,42.20755],[-74.03146,42.20639],[-74.03124,42.20604],[-74.03116,42.20522],[-74.0303,42.20426],[-74.03029,42.20384],[-74.03056,42.20345],[-74.0303,42.20289],[-74.03041,42.20244],[-74.0302,42.20218],[-74.02959,42.20201],[-74.02989,42.20141],[-74.0309,42.20053],[-74.03087,42.2003],[-74.03107,42.20006],[-74.03127,42.19935],[-74.03182,42.19884],[-74.03227,42.19871],[-74.03245,42.19849],[-74.03355,42.198],[-74.03458,42.19732],[-74.03475,42.19706],[-74.03479,42.19637]]}},{"type":"Feature","properties":{"name":"Escarpment Trail","blaze":"red"},"geometry":{"type":"LineString","coordinates":[[-74.05816,42.20063],[-74.05778,42.20038],[-74.05757,42.20004],[-74.05796,42.19952],[-74.05774,42.19921],[-74.05777,42.19899],[-74.05816,42.19849],[-74.05789,42.19796],[-74.05807,42.19754],[-74.05776,42.19709],[-74.05749,42.19603],[-74.05796,42.19541],[-74.05803,42.19491],[-74.05841,42.19432],[-74.05931,42.19446],[-74.06013,42.19419],[-74.06134,42.19355],[-74.06158,42.19307],[-74.06349,42.19202],[-74.06656,42.18963],[-74.06687,42.18926],[-74.06706,42.1892],[-74.06746,42.18935],[-74.06828,42.18904],[-74.06786,42.18844],[-74.06747,42.18803],[-74.06666,42.18768],[-74.06622,42.18772],[-74.06439,42.18719],[-74.06318,42.18727],[-74.06107,42.18674],[-74.05933,42.1858],[-74.05901,42.18557],[-74.05869,42.18471],[-74.0578,42.18437],[-74.05731,42.18438],[-74.05506,42.18513],[-74.05399,42.18532],[-74.05204,42.18502],[-74.05048,42.18457],[-74.04998,42.18459],[-74.04935,42.18428],[-74.04807,42.18402],[-74.04702,42.18414],[-74.04612,42.18476],[-74.0461,42.18492]]}},{"type":"Feature","properties":{"name":"Escarpment Trail","blaze":"red"},"geometry":{"type":"LineString","coordinates":[[-74.05028,42.18812],[-74.04898,42.18862],[-74.04778,42.18858],[-74.04485,42.18957],[-74.04323,42.18976],[-74.04103,42.19045],[-74.03978,42.19129],[-74.03958,42.19116],[-74.03973,42.19063],[-74.03951,42.19015],[-74.03823,42.18946],[-74.03756,42.18938],[-74.03764,42.1897],[-74.03748,42.19061],[-74.03685,42.19093],[-74.0367,42.19146],[-74.03629,42.1916],[-74.03609,42.19195],[-74.0359,42.19283],[-74.03537,42.19376],[-74.03532,42.19441],[-74.03542,42.19457],[-74.03487,42.19471]]}},{"type":"Feature","properties":{"name":"Black Dome Range Trail","blaze":"yellow"},"geometry":{"type":"LineString","coordinates":[[-74.17667,42.26399],[-74.17278,42.26214],[-74.17105,42.26015],[-74.1708,42.26011],[-74.17045,42.26027],[-74.16959,42.26187],[-74.16878,42.26262],[-74.16777,42.26409],[-74.16706,42.26409],[-74.16691,42.26454],[-74.16649,42.26407],[-74.16601,42.26406],[-74.16592,42.26466],[-74.1649,42.2652],[-74.16436,42.26625],[-74.16289,42.26685],[-74.16071,42.26841],[-74.15924,42.26871],[-74.15776,42.26967],[-74.15644,42.27031],[-74.15539,42.27049],[-74.15459,42.27103],[-74.15237,42.27082],[-74.15079,42.2709],[-74.14985,42.2712],[-74.14902,42.27234],[-74.14805,42.27268],[-74.14461,42.27296],[-74.14272,42.27251],[-74.13945,42.27116],[-74.13636,42.27043],[-74.13482,42.27084],[-74.13353,42.2708],[-74.13145,42.27058],[-74.1305,42.27009],[-74.12878,42.27019],[-74.1267,42.26974],[-74.12283,42.27029],[-74.12147,42.26991],[-74.11843,42.27076],[-74.11775,42.27072],[-74.11771,42.27052],[-74.1165,42.27062],[-74.11435,42.27028],[-74.11416,42.27052],[-74.1143,42.27074],[-74.11518,42.27134],[-74.11566,42.27208],[-74.114,42.27205],[-74.11463,42.27247],[-74.11385,42.27233],[-74.11271,42.27328],[-74.11246,42.27445],[-74.11264,42.27507],[-74.11258,42.27693],[-74.11236,42.2774],[-74.11262,42.27798],[-74.1131,42.27831],[-74.1119,42.27905],[-74.11169,42.2797],[-74.11075,42.28029],[-74.10945,42.28183],[-74.10824,42.2822],[-74.10795,42.28311],[-74.10812,42.28383],[-74.11012,42.28714],[-74.11132,42.28772],[-74.11312,42.28815],[-74.11435,42.2888]]}},{"type":"Feature","properties":{"name":"Kaaterskill High Peak Trail","blaze":"red"},"geometry":{"type":"LineString","coordinates":[[-74.11771,42.1791],[-74.11772,42.17977],[-74.11731,42.18022],[-74.11558,42.18045],[-74.11296,42.17892],[-74.11238,42.17831],[-74.1084,42.17643],[-74.10706,42.17642],[-74.10673,42.17669],[-74.10561,42.17691],[-74.10357,42.17676],[-74.10276,42.17728],[-74.10097,42.17772],[-74.09709,42.17733],[-74.09554,42.17635],[-74.09525,42.17568],[-74.09283,42.17359],[-74.09269,42.17319],[-74.09137,42.17204],[-74.09119,42.17131],[-74.08951,42.16973],[-74.08658,42.16946],[-74.08562,42.16868],[-74.08445,42.16857],[-74.08369,42.16878],[-74.08167,42.16761],[-74.0804,42.16757],[-74.07885,42.16633],[-74.07617,42.16527],[-74.0739,42.16376],[-74.0709,42.16128],[-74.07063,42.15972],[-74.07085,42.15865],[-74.07132,42.1582],[-74.07238,42.15786],[-74.07726,42.15913],[-74.08107,42.15845],[-74.08351,42.1574],[-74.08446,42.15723],[-74.08565,42.15736],[-74.08685,42.15825],[-74.08734,42.15903],[-74.08796,42.16078],[-74.08793,42.16198],[-74.08822,42.16291],[-74.08871,42.16354],[-74.09067,42.16454],[-74.09308,42.16504],[-74.09424,42.1651],[-74.09575,42.16455],[-74.09622,42.16344],[-74.09957,42.16115],[-74.10047,42.16087],[-74.10163,42.16126],[-74.10212,42.16196],[-74.10349,42.16314],[-74.10391,42.165],[-74.10374,42.16637],[-74.10389,42.16734],[-74.10356,42.16771],[-74.10249,42.1675],[-74.10142,42.16918],[-74.1008,42.17141],[-74.09971,42.17204],[-74.09957,42.17319],[-74.1002,42.17368],[-74.10539,42.17598],[-74.10626,42.17671]]}},{"type":"Feature","properties":{"name":"Colgate Lake Trail","blaze":"yellow"},"geometry":{"type":"LineString","coordinates":[[-74.11636,42.23858],[-74.11589,42.24138],[-74.11591,42.24355],[-74.11495,42.24486],[-74.11245,42.24504],[-74.10503,42.24417],[-74.1044,42.24441],[-74.10384,42.24502],[-74.10252,42.24558],[-74.10144,42.24558],[-74.10005,42.245],[-74.09959,42.24553],[-74.09767,42.24643],[-74.09727,42.24682],[-74.09682,42.2465],[-74.0963,42.24539],[-74.09752,42.24428],[-74.09804,42.24293],[-74.09873,42.24223],[-74.09918,42.2421],[-74.09841,42.24107],[-74.09742,42.24052],[-74.0938,42.2409],[-74.09194,42.24037],[-74.09178,42.24019],[-74.09205,42.2397],[-74.09301,42.23877],[-74.09368,42.23762],[-74.09175,42.23772],[-74.09075,42.23678],[-74.08941,42.23624],[-74.08869,42.23553],[-74.08818,42.23559],[-74.08746,42.2368],[-74.08619,42.23645],[-74.08383,42.23629],[-74.08271,42.23694],[-74.08213,42.23873],[-74.08126,42.23932],[-74.08031,42.24041],[-74.07789,42.24665],[-74.0766,42.24782],[-74.07605,42.2487],[-74.07538,42.24913]]}},{"type":"Feature","properties":{"name":"Stoppel Point Trail","blaze":"red"},"geometry":{"type":"LineString","coordinates":[[-74.03622,42.23969],[-74.03676,42.23974],[-74.03797,42.2387],[-74.03871,42.239],[-74.03902,42.23891],[-74.03932,42.23838],[-74.04089,42.23843],[-74.04151,42.23798],[-74.04228,42.23806],[-74.04296,42.2375],[-74.04323,42.2377],[-74.04441,42.23761],[-74.04627,42.23794],[-74.04801,42.23729],[-74.04863,42.23753],[-74.05115,42.23702],[-74.05322,42.23716],[-74.05359,42.23696],[-74.05399,42.23604],[-74.05412,42.23454],[-74.05493,42.23435],[-74.05603,42.23324],[-74.05662,42.23207],[-74.05648,42.23067],[-74.05691,42.2305]]}},{"type":"Feature","properties":{"name":"North Lake South Lake Trail","blaze":"blue"},"geometry":{"type":"LineString","coordinates":[[-74.03437,42.19936],[-74.036,42.19727],[-74.03667,42.19708],[-74.04074,42.19877],[-74.04158,42.19675],[-74.04241,42.19656],[-74.04297,42.19533],[-74.04513,42.19486],[-74.04679,42.19507],[-74.04717,42.19532],[-74.04888,42.1951],[-74.04915,42.19538],[-74.04999,42.19535],[-74.05078,42.19586],[-74.05117,42.19668],[-74.04688,42.19777],[-74.04501,42.19853],[-74.0434,42.19997]]}},{"type":"Feature","properties":{"name":"Dutcher Notch Trail","blaze":"yellow"},"geometry":{"type":"LineString","coordinates":[[-74.0539,42.25206],[-74.05456,42.25057],[-74.05581,42.24893],[-74.05667,42.24845],[-74.05739,42.24697],[-74.05904,42.24597],[-74.06028,42.24424],[-74.06196,42.24273],[-74.06288,42.24293],[-74.06318,42.24393],[-74.0639,42.24468],[-74.06686,42.24584],[-74.06841,42.24716],[-74.07099,42.24823],[-74.0727,42.24971],[-74.07333,42.24978],[-74.07538,42.24913]]}},{"type":"Feature","properties":{"name":"Batavia Kill Trail","blaze":"yellow"},"geometry":{"type":"LineString","coordinates":[[-74.09809,42.27569],[-74.09879,42.27602],[-74.10002,42.27526],[-74.10105,42.27519],[-74.10015,42.27589],[-74.10043,42.27666],[-74.10119,42.27709],[-74.1012,42.27786],[-74.10153,42.27817],[-74.10164,42.27872],[-74.10349,42.27924],[-74.10512,42.28012],[-74.10519,42.28079],[-74.10598,42.2817],[-74.10765,42.28312],[-74.10792,42.28311]]}},{"type":"Feature","properties":{"name":"Black Dome Range Trail","blaze":"yellow"},"geometry":{"type":"LineString","coordinates":[[-74.11063,42.30056],[-74.10888,42.29915],[-74.10863,42.29813],[-74.10995,42.29628],[-74.11078,42.29423],[-74.11152,42.2936],[-74.11222,42.29236],[-74.11407,42.29167],[-74.11477,42.29083],[-74.11472,42.29014],[-74.11607,42.28928]]}},{"type":"Feature","properties":{"name":"Kaaterskill Falls Trail","blaze":"yellow"},"geometry":{"type":"LineString","coordinates":[[-74.0629,42.1923],[-74.06411,42.19237],[-74.06607,42.19168],[-74.06585,42.19238],[-74.06449,42.19326],[-74.06457,42.19344],[-74.06776,42.19355],[-74.06964,42.19253],[-74.07004,42.19208],[-74.07016,42.1914],[-74.07058,42.19114]]}},{"type":"Feature","properties":{"name":"Elm Ridge Trail","blaze":"yellow"},"geometry":{"type":"LineString","coordinates":[[-74.16935,42.29661],[-74.16913,42.29732],[-74.1692,42.29919],[-74.16884,42.29975],[-74.16887,42.30078],[-74.16936,42.30203],[-74.17013,42.30321],[-74.17159,42.30436],[-74.17413,42.30503],[-74.17467,42.30659]]}},{"type":"Feature","properties":{"name":"Schutt Road","blaze":null},"geometry":{"type":"LineString","coordinates":[[-74.05028,42.18812],[-74.05048,42.18822],[-74.05339,42.18698],[-74.05525,42.18658],[-74.05672,42.18705],[-74.05958,42.18984],[-74.06062,42.19173],[-74.06033,42.19222],[-74.05953,42.19267],[-74.05841,42.19432]]}},{"type":"Feature","properties":{"name":"Long Path","blaze":"blue"},"geometry":{"type":"LineString","coordinates":[[-74.19035,42.3131],[-74.19024,42.31381],[-74.1893,42.3145],[-74.18686,42.315],[-74.18644,42.3156],[-74.18669,42.31722],[-74.18579,42.31928],[-74.18677,42.32017],[-74.1875,42.32034]]}},{"type":"Feature","properties":{"name":"Blackhead Trail","blaze":"red"},"geometry":{"type":"LineString","coordinates":[[-74.11435,42.27028],[-74.1126,42.27043],[-74.11088,42.26969],[-74.10981,42.27],[-74.10816,42.26986],[-74.10734,42.2695],[-74.10709,42.26894],[-74.10464,42.26774]]}},{"type":"Feature","properties":{"name":"North Lake South Lake Trail","blaze":"blue"},"geometry":{"type":"LineString","coordinates":[[-74.04084,42.20089],[-74.0396,42.20082],[-74.03865,42.20146],[-74.03805,42.20157],[-74.03633,42.20155]]}}]};

let map;
let courseVisible = true;
let terrain3D = false;
let trailsOn = false;
let aidVisible = false;
const aidMarkers = [];

const AID_STATIONS = [
  { name: 'Windham Peak', mile: 3.5, services: 'Water, Tailwind, snacks' },
  { name: 'Acra', mile: 6.2, services: 'Water, Tailwind, snacks' },
  { name: 'Base of Blackhead', mile: 8.7, services: 'Water, Tailwind, snacks' },
  { name: 'Top of Blackhead', mile: 9.6, services: 'Water, Tailwind, snacks' },
  { name: "Dutcher's Notch", mile: 12.2, services: 'Water, Tailwind, snacks' },
  { name: 'Stoppel Point', mile: 14.4, services: 'Water, Tailwind, snacks' },
  { name: 'North Point', mile: 16.2, services: 'Water, Tailwind, snacks' }
];

function initMap() {
  map = new maplibregl.Map({
    container: 'map',
    style: BASEMAP_STYLE,
    center: [-74.1096, 42.2495],
    zoom: 11,
    pitch: 0,
    attributionControl: false
  });

  map.addControl(new maplibregl.AttributionControl({ compact: true }));
  map.once('load', () => {
    const attrib = document.querySelector('.maplibregl-ctrl-attrib');
    if (attrib) { attrib.removeAttribute('open'); attrib.classList.remove('maplibregl-compact-show'); }
  });
  map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

  map.on('load', () => {
    // Hide basemap trail/path layers that conflict with our custom overlays
    ['roads_other','roads_bridges_other','roads_bridges_other_casing',
     'roads_tunnels_other','roads_tunnels_other_casing','roads_labels_minor'
    ].forEach(id => { if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', 'none'); });

    // Add course line (dark line + brand color glow for contrast on green basemap)
    map.addSource('course', { type: 'geojson', data: COURSE });
    map.addLayer({
      id: 'course-outline',
      type: 'line',
      source: 'course',
      paint: {
        'line-color': '#2E7D32',
        'line-width': 7,
        'line-opacity': 0.45
      }
    });
    map.addLayer({
      id: 'course-line',
      type: 'line',
      source: 'course',
      paint: {
        'line-color': '#111111',
        'line-width': 4
      }
    });

    // Add start marker
    const startEl = document.createElement('div');
    startEl.className = 'start-marker';
    startEl.innerHTML = '<svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="#2E7D32" stroke="#fff" stroke-width="2"/><text x="16" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff">S</text></svg>';
    new maplibregl.Marker({ element: startEl })
      .setLngLat(START_COORDS)
      .setPopup(new maplibregl.Popup({ offset: 15 }).setHTML('<strong style="color:#2E7D32">Start - Windham, NY</strong><br><span style="color:#888">Escarpment Trail Run 30K</span>'))
      .addTo(map);

    // Add finish marker
    const finishEl = document.createElement('div');
    finishEl.className = 'start-marker';
    finishEl.innerHTML = '<svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="#2E7D32" stroke="#fff" stroke-width="2"/><text x="16" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff">F</text></svg>';
    new maplibregl.Marker({ element: finishEl })
      .setLngLat(FINISH_COORDS)
      .setPopup(new maplibregl.Popup({ offset: 15 }).setHTML('<strong style="color:#2E7D32">Finish - Haines Falls, NY</strong><br><span style="color:#888">Escarpment Trail Run 30K</span>'))
      .addTo(map);

    // Mile markers
    const MILE_MARKER_GEOJSON = { type: 'FeatureCollection', features: [] };
    for (let m = 1; m <= Math.floor(TOTAL_MILES); m++) {
      MILE_MARKER_GEOJSON.features.push({
        type: 'Feature',
        properties: { mile: m, label: String(m), priority: (m % 5 === 0) ? 1 : 2 },
        geometry: { type: 'Point', coordinates: getCoordAtDist(m) }
      });
    }
    map.addSource('mile-markers', { type: 'geojson', data: MILE_MARKER_GEOJSON });
    map.addLayer({
      id: 'mile-markers-circle',
      type: 'circle',
      source: 'mile-markers',
      paint: {
        'circle-radius': 10,
        'circle-color': '#222',
        'circle-stroke-color': '#2E7D32',
        'circle-stroke-width': 2
      },
      filter: ['step', ['zoom'], ['==', ['get', 'priority'], 1], 13.5, true]
    });
    map.addLayer({
      id: 'mile-markers-label',
      type: 'symbol',
      source: 'mile-markers',
      layout: {
        'text-field': ['get', 'label'],
        'text-font': ['Noto Sans Medium'],
        'text-size': 10,
        'text-allow-overlap': true
      },
      paint: {
        'text-color': '#fff'
      },
      filter: ['step', ['zoom'], ['==', ['get', 'priority'], 1], 13.5, true]
    });

    // Aid station markers (hidden by default)
    AID_STATIONS.forEach(station => {
      const coords = getCoordAtDist(station.mile);
      const el = document.createElement('div');
      el.className = 'aid-marker';
      el.innerHTML = '<svg viewBox="0 0 28 28"><circle cx="14" cy="14" r="11" fill="#2E7D32" stroke="#fff" stroke-width="2"/><text x="14" y="18" text-anchor="middle" font-size="14" font-weight="bold" fill="#fff">+</text></svg>';
      const marker = new maplibregl.Marker({ element: el })
        .setLngLat(coords)
        .setPopup(new maplibregl.Popup({ offset: 15 }).setHTML(
          '<strong style="color:#2E7D32">' + station.name + '</strong>' +
          '<br><span style="color:#888">Mile ' + station.mile + '</span>' +
          '<br><span style="font-size:0.8rem;color:#555">' + station.services + '</span>'
        ));
      aidMarkers.push(marker);
    });

    // Fit to course bounds
    const bounds = new maplibregl.LngLatBounds();
    COURSE_COORDS.forEach(coord => bounds.extend(coord));
    map.fitBounds(bounds, { padding: 40 });
  });
}

function toggleCourse() {
  courseVisible = !courseVisible;
  document.getElementById('courseBtn').classList.toggle('active', courseVisible);
  const vis = courseVisible ? 'visible' : 'none';
  if (map.getLayer('course-line')) {
    map.setLayoutProperty('course-line', 'visibility', vis);
    map.setLayoutProperty('course-outline', 'visibility', vis);
  }
  if (map.getLayer('mile-markers-circle')) {
    map.setLayoutProperty('mile-markers-circle', 'visibility', vis);
    map.setLayoutProperty('mile-markers-label', 'visibility', vis);
  }
}

function toggle3D() {
  terrain3D = !terrain3D;
  document.getElementById('terrainBtn').classList.toggle('active', terrain3D);
  if (terrain3D) {
    if (!map.getSource('terrain-dem')) {
      map.addSource('terrain-dem', {
        type: 'raster-dem',
        tiles: ['https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'],
        tileSize: 256, maxzoom: 15, encoding: 'terrarium'
      });
    }
    map.setTerrain({ source: 'terrain-dem', exaggeration: 1.5 });
    map.easeTo({ pitch: 45, duration: 1000 });
  } else {
    map.setTerrain(null);
    map.easeTo({ pitch: 0, duration: 1000 });
  }
}

function toggleTrails() {
  trailsOn = !trailsOn;
  document.getElementById('trailBtn').classList.toggle('active', trailsOn);
  if (!map) return;

  if (trailsOn) {
    if (!map.getSource('park-trails')) {
      addTrailLayers();
    }
    map.setLayoutProperty('park-trails-line', 'visibility', 'visible');
    map.setLayoutProperty('park-trails-label', 'visibility', 'visible');
  } else {
    if (map.getLayer('park-trails-line')) map.setLayoutProperty('park-trails-line', 'visibility', 'none');
    if (map.getLayer('park-trails-label')) map.setLayoutProperty('park-trails-label', 'visibility', 'none');
  }
}

function addTrailLayers() {
  if (!map.getSource('park-trails')) {
    map.addSource('park-trails', { type: 'geojson', data: TRAILS_DATA });
  }
  if (!map.getLayer('park-trails-line')) {
    map.addLayer({
      id: 'park-trails-line',
      type: 'line',
      source: 'park-trails',
      paint: {
        'line-color': ['match', ['get', 'blaze'],
          'white', '#ffffff',
          'blue', '#2196F3',
          'yellow', '#FFD700',
          'orange', '#FF9800',
          'green', '#4CAF50',
          'red', '#f44336',
          'violet', '#9C27B0',
          '#9E9E9E'
        ],
        'line-width': ['interpolate', ['linear'], ['zoom'], 12, 3, 15, 5, 20, 8],
        'line-dasharray': [2, 3],
        'line-opacity': 0.9
      },
      layout: { 'line-cap': 'butt', 'line-join': 'round' }
    });
  }
  if (!map.getLayer('park-trails-label')) {
    map.addLayer({
      id: 'park-trails-label',
      type: 'symbol',
      source: 'park-trails',
      layout: {
        'symbol-placement': 'line',
        'text-field': ['get', 'name'],
        'text-size': ['interpolate', ['linear'], ['zoom'], 13, 9, 16, 13, 20, 16],
        'text-font': ['Noto Sans Medium'],
        'text-max-angle': 30,
        'text-padding': 10
      },
      paint: {
        'text-color': '#333',
        'text-halo-color': '#fff',
        'text-halo-width': 1.5,
        'text-opacity': ['interpolate', ['linear'], ['zoom'], 13, 0, 13.5, 1]
      }
    });
  }
}

function toggleAidStations() {
  aidVisible = !aidVisible;
  document.getElementById('aidBtn').classList.toggle('active', aidVisible);
  aidMarkers.forEach(m => { if (aidVisible) m.addTo(map); else m.remove(); });
}

function drawElevationProfile() {
  const canvas = document.getElementById('profileCanvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);

  const w = rect.width;
  const h = rect.height;
  const padding = { top: 10, right: 10, bottom: 25, left: 40 };
  const chartW = w - padding.left - padding.right;
  const chartH = h - padding.top - padding.bottom;

  const maxDist = 18.6;
  const maxEle = 1250; // meters (~4,100 ft)
  const minEle = 500;  // meters (~1,640 ft)

  // Draw grid
  ctx.strokeStyle = '#dddddd';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = padding.top + (chartH / 4) * i;
    ctx.beginPath();
    ctx.moveTo(padding.left, y);
    ctx.lineTo(w - padding.right, y);
    ctx.stroke();
  }

  // Draw elevation area
  ctx.beginPath();
  ctx.moveTo(padding.left, padding.top + chartH);
  ELEVATIONS.forEach((ele, i) => {
    const x = padding.left + (i / (ELEVATIONS.length - 1)) * chartW;
    const y = padding.top + chartH - ((ele - minEle) / (maxEle - minEle)) * chartH;
    if (i === 0) ctx.lineTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.lineTo(padding.left + chartW, padding.top + chartH);
  ctx.closePath();
  const gradient = ctx.createLinearGradient(0, padding.top, 0, padding.top + chartH);
  gradient.addColorStop(0, 'rgba(46, 125, 50, 0.4)');
  gradient.addColorStop(1, 'rgba(46, 125, 50, 0.05)');
  ctx.fillStyle = gradient;
  ctx.fill();

  // Draw elevation line
  ctx.beginPath();
  ELEVATIONS.forEach((ele, i) => {
    const x = padding.left + (i / (ELEVATIONS.length - 1)) * chartW;
    const y = padding.top + chartH - ((ele - minEle) / (maxEle - minEle)) * chartH;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Draw labels
  ctx.fillStyle = '#888888';
  ctx.font = '10px Inter, sans-serif';
  ctx.textAlign = 'center';
  for (let m = 0; m <= 18; m += 3) {
    const x = padding.left + (m / maxDist) * chartW;
    ctx.fillText(m + ' mi', x, h - 8);
  }
  ctx.textAlign = 'right';
  // Convert meters to feet for display
  const minFt = Math.round(minEle * 3.28084);
  const midEle = (minEle + maxEle) / 2;
  const midFt = Math.round(midEle * 3.28084);
  const maxFt = Math.round(maxEle * 3.28084);
  ctx.fillText(minFt.toLocaleString() + ' ft', padding.left - 5, padding.top + chartH);
  ctx.fillText(midFt.toLocaleString() + ' ft', padding.left - 5, padding.top + chartH / 2);
  ctx.fillText(maxFt.toLocaleString() + ' ft', padding.left - 5, padding.top + 10);
}

document.getElementById('courseBtn').onclick = toggleCourse;
document.getElementById('trailBtn').onclick = toggleTrails;
document.getElementById('aidBtn').onclick = toggleAidStations;
document.getElementById('terrainBtn').onclick = toggle3D;

// 
// VIEW SWITCHING
// 
let currentView = 'map';
let mapInitialized = false;
let simInitialized = false;

function switchView(view) {
  currentView = view;
  document.querySelectorAll('.view-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(view + 'View').classList.add('active');
  if (view === 'map' && !mapInitialized) {
    initMap();
    mapInitialized = true;
  }
  if (view === 'sim') {
    initSim();
    renderSim();
  }
}

// 
// SIMULATOR
// 
const TOTAL_MILES = 18.6;
const TOTAL_GAIN = 4800; // feet (approximate)
const RACE_START_HOUR = 9; // 9:00 AM
let simProgress = 0;
let simPlaying = false;
let simSpeed = 1;
let simFinishHours = 4.0;
let simLastTick = 0;

// Build distance array for each coordinate (cumulative miles)
const coordDistances = [0];
for (let i = 1; i < COURSE_COORDS.length; i++) {
  const [x1, y1] = COURSE_COORDS[i - 1];
  const [x2, y2] = COURSE_COORDS[i];
  const dLng = (x2 - x1) * Math.cos((y1 + y2) / 2 * Math.PI / 180) * 69.172;
  const dLat = (y2 - y1) * 69.172;
  coordDistances.push(coordDistances[i - 1] + Math.sqrt(dLng * dLng + dLat * dLat));
}
// Normalize to actual total miles
const rawTotal = coordDistances[coordDistances.length - 1];
for (let i = 0; i < coordDistances.length; i++) {
  coordDistances[i] = (coordDistances[i] / rawTotal) * TOTAL_MILES;
}

// Build elevation profile indexed by distance (in feet)
const eleProfile = ELEVATIONS.map((e, i) => ({
  d: (i / (ELEVATIONS.length - 1)) * TOTAL_MILES,
  e: e * 3.28084 // meters to feet
}));

function getEleAtDist(dist) {
  for (let i = 1; i < eleProfile.length; i++) {
    if (eleProfile[i].d >= dist) {
      const p0 = eleProfile[i - 1], p1 = eleProfile[i];
      const dRange = p1.d - p0.d;
      const t = dRange > 0 ? (dist - p0.d) / dRange : 0;
      return p0.e + (p1.e - p0.e) * t;
    }
  }
  return eleProfile[eleProfile.length - 1].e;
}

function getGradeAtDist(dist) {
  const delta = 0.05;
  const e1 = getEleAtDist(Math.max(0, dist - delta));
  const e2 = getEleAtDist(Math.min(TOTAL_MILES, dist + delta));
  const dDist = delta * 2 * 5280;
  return dDist > 0 ? ((e2 - e1) / dDist) * 100 : 0;
}

function getGainAtDist(dist) {
  return (dist / TOTAL_MILES) * TOTAL_GAIN;
}

function getCoordAtDist(dist) {
  for (let i = 1; i < coordDistances.length; i++) {
    if (coordDistances[i] >= dist) {
      const t = (dist - coordDistances[i - 1]) / (coordDistances[i] - coordDistances[i - 1]);
      const c0 = COURSE_COORDS[i - 1], c1 = COURSE_COORDS[i];
      return [c0[0] + (c1[0] - c0[0]) * t, c0[1] + (c1[1] - c0[1]) * t];
    }
  }
  return COURSE_COORDS[COURSE_COORDS.length - 1];
}

function initSim() {
  if (simInitialized) return;
  simInitialized = true;
  updateGoalPace();

  // Scrubber interaction
  const track = document.getElementById('scrubTrack');
  let scrubbing = false;
  const scrubTo = e => {
    const rect = track.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    simProgress = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
    renderSim();
  };
  track.addEventListener('mousedown', e => { scrubbing = true; simPlaying = false; document.getElementById('playBtn').innerHTML = '&#9654;'; scrubTo(e); });
  window.addEventListener('mousemove', e => { if (scrubbing) scrubTo(e); });
  window.addEventListener('mouseup', () => scrubbing = false);
  track.addEventListener('touchstart', e => { scrubbing = true; simPlaying = false; document.getElementById('playBtn').innerHTML = '&#9654;'; scrubTo(e); }, { passive: true });
  window.addEventListener('touchmove', e => { if (scrubbing) scrubTo(e); }, { passive: true });
  window.addEventListener('touchend', () => scrubbing = false);
}

function updateGoalTime() {
  const h = parseInt(document.getElementById('goalHrs').value) || 0;
  const m = parseInt(document.getElementById('goalMins').value) || 0;
  simFinishHours = h + m / 60;
  if (simFinishHours < 0.1) simFinishHours = 0.1;
  updateGoalPace();
  renderSim();
}

function updateGoalPace() {
  const totalMins = simFinishHours * 60;
  const paceMin = totalMins / TOTAL_MILES;
  const pm = Math.floor(paceMin);
  const ps = Math.round((paceMin - pm) * 60);
  document.getElementById('goalPace').innerHTML = 'Avg pace: <strong>' + pm + ':' + String(ps).padStart(2, '0') + ' /mi</strong>';
}

function togglePlay() {
  simPlaying = !simPlaying;
  document.getElementById('playBtn').innerHTML = simPlaying ? '&#9208;' : '&#9654;';
  if (simPlaying) {
    if (simProgress >= 0.999) simProgress = 0;
    simLastTick = performance.now();
    simTick();
  }
}

function setSpeed(s, btn) {
  simSpeed = s;
  document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function simTick() {
  if (!simPlaying) return;
  const now = performance.now();
  const dt = (now - simLastTick) / 1000;
  simLastTick = now;
  simProgress = Math.min(1, simProgress + (1 / 30) * simSpeed * dt);
  renderSim();
  if (simProgress >= 1) {
    simPlaying = false;
    document.getElementById('playBtn').innerHTML = '&#9654;';
    return;
  }
  requestAnimationFrame(simTick);
}

function renderSim() {
  const dist = simProgress * TOTAL_MILES;
  const ele = getEleAtDist(dist);
  const grade = getGradeAtDist(dist);
  const gain = getGainAtDist(dist);

  // Scrubber
  document.getElementById('scrubFill').style.width = (simProgress * 100) + '%';
  document.getElementById('scrubHandle').style.left = (simProgress * 100) + '%';

  // Runner info
  document.getElementById('runnerDist').textContent = 'Mile ' + dist.toFixed(1);
  const gradeDir = grade > 2 ? 'Climbing' : grade < -2 ? 'Descending' : 'Rolling';
  document.getElementById('runnerMeta').textContent = Math.round(ele).toLocaleString() + ' ft \u00b7 ' + gradeDir;

  // Clock
  const elapsed = (dist / TOTAL_MILES) * simFinishHours;
  const tod = RACE_START_HOUR + elapsed;
  const hrs = Math.floor(tod) % 24;
  const mins = Math.floor((tod % 1) * 60);
  const ampm = hrs >= 12 ? 'PM' : 'AM';
  const dispHrs = hrs > 12 ? hrs - 12 : (hrs === 0 ? 12 : hrs);
  document.getElementById('clockTime').textContent = dispHrs + ':' + String(mins).padStart(2, '0') + ' ' + ampm;

  const finishTod = RACE_START_HOUR + simFinishHours;
  const finishHrs = Math.floor(finishTod) % 24;
  const finishMins = Math.round((finishTod % 1) * 60);
  const finishAmpm = finishHrs >= 12 ? 'PM' : 'AM';
  const finishDispHrs = finishHrs > 12 ? finishHrs - 12 : (finishHrs === 0 ? 12 : finishHrs);
  document.getElementById('finishTime').textContent = finishDispHrs + ':' + String(finishMins).padStart(2, '0') + ' ' + finishAmpm;

  // Stats
  document.getElementById('statDist').textContent = dist.toFixed(1);
  document.getElementById('statEle').textContent = Math.round(ele).toLocaleString();
  document.getElementById('statGain').textContent = Math.round(gain).toLocaleString();
  document.getElementById('statGrade').textContent = (grade > 0 ? '+' : '') + grade.toFixed(0) + '%';
  document.getElementById('statPct').textContent = Math.round(simProgress * 100) + '%';

  // Pace
  const totalMins = simFinishHours * 60;
  const paceMin = totalMins / TOTAL_MILES;
  const pm = Math.floor(paceMin);
  const ps = Math.round((paceMin - pm) * 60);
  document.getElementById('statPace').textContent = pm + ':' + String(ps).padStart(2, '0');

  // Draw canvases
  renderCourseMap(dist);
  renderSimProfile(dist, ele);
}

// 
// COURSE MAP CANVAS - bird's-eye view of the course with runner dot
// 
function renderCourseMap(currentDist) {
  const canvas = document.getElementById('courseMapCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;

  // Background
  const bgGrad = ctx.createLinearGradient(0, 0, 0, H);
  bgGrad.addColorStop(0, '#e8ede9');
  bgGrad.addColorStop(1, '#dde3de');
  ctx.fillStyle = bgGrad;
  ctx.fillRect(0, 0, W, H);

  // Compute bounding box of course
  let minLng = Infinity, maxLng = -Infinity, minLat = Infinity, maxLat = -Infinity;
  for (const [lng, lat] of COURSE_COORDS) {
    if (lng < minLng) minLng = lng;
    if (lng > maxLng) maxLng = lng;
    if (lat < minLat) minLat = lat;
    if (lat > maxLat) maxLat = lat;
  }
  const padding = 15;
  const drawW = W - padding * 2;
  const drawH = H - padding * 2;
  const lngRange = maxLng - minLng;
  const latRange = maxLat - minLat;
  const scale = Math.min(drawW / lngRange, drawH / latRange);
  const offsetX = padding + (drawW - lngRange * scale) / 2;
  const offsetY = padding + (drawH - latRange * scale) / 2;

  const toX = lng => offsetX + (lng - minLng) * scale;
  const toY = lat => offsetY + (maxLat - lat) * scale; // flip Y

  // Draw completed portion (bright)
  const runnerCoord = getCoordAtDist(currentDist);
  let runnerIdx = 0;
  for (let i = 1; i < coordDistances.length; i++) {
    if (coordDistances[i] >= currentDist) { runnerIdx = i; break; }
  }

  // Draw trail shadow (full course, dim)
  ctx.beginPath();
  for (let i = 0; i < COURSE_COORDS.length; i++) {
    const x = toX(COURSE_COORDS[i][0]);
    const y = toY(COURSE_COORDS[i][1]);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.strokeStyle = 'rgba(0,0,0,0.08)';
  ctx.lineWidth = 6;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.stroke();

  // Draw remaining portion (dim green)
  ctx.beginPath();
  for (let i = Math.max(0, runnerIdx - 1); i < COURSE_COORDS.length; i++) {
    const x = toX(COURSE_COORDS[i][0]);
    const y = toY(COURSE_COORDS[i][1]);
    if (i === Math.max(0, runnerIdx - 1)) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.strokeStyle = 'rgba(46,125,50,0.4)';
  ctx.lineWidth = 4;
  ctx.stroke();

  // Draw completed portion (bright green)
  if (runnerIdx > 0) {
    ctx.beginPath();
    for (let i = 0; i <= Math.min(runnerIdx, COURSE_COORDS.length - 1); i++) {
      const x = toX(COURSE_COORDS[i][0]);
      const y = toY(COURSE_COORDS[i][1]);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    // Also draw to exact runner position
    const rx = toX(runnerCoord[0]);
    const ry = toY(runnerCoord[1]);
    ctx.lineTo(rx, ry);
    ctx.strokeStyle = '#2E7D32';
    ctx.lineWidth = 4;
    ctx.stroke();
  }

  // Start marker
  const sx = toX(COURSE_COORDS[0][0]);
  const sy = toY(COURSE_COORDS[0][1]);
  ctx.beginPath();
  ctx.arc(sx, sy, 6, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.fillStyle = '#2E7D32';
  ctx.font = 'bold 8px Inter, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('S', sx, sy + 0.5);

  // Finish marker
  const fx = toX(COURSE_COORDS[COURSE_COORDS.length - 1][0]);
  const fy = toY(COURSE_COORDS[COURSE_COORDS.length - 1][1]);
  ctx.beginPath();
  ctx.arc(fx, fy, 6, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.fillStyle = '#2E7D32';
  ctx.font = 'bold 8px Inter, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('F', fx, fy + 0.5);

  // Runner dot
  const rx = toX(runnerCoord[0]);
  const ry = toY(runnerCoord[1]);

  // Glow
  ctx.beginPath();
  ctx.arc(rx, ry, 14, 0, Math.PI * 2);
  const glow = ctx.createRadialGradient(rx, ry, 4, rx, ry, 14);
  glow.addColorStop(0, 'rgba(46,125,50,0.4)');
  glow.addColorStop(1, 'rgba(46,125,50,0)');
  ctx.fillStyle = glow;
  ctx.fill();

  // Dot
  ctx.beginPath();
  ctx.arc(rx, ry, 7, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 3;
  ctx.stroke();

  // Mile markers  priority-based with collision suppression
  const markerR = Math.max(8, Math.min(11, W / 35));
  const markerFont = Math.max(7, Math.min(9, W / 45));
  const gap = 3;
  const candidates = [];
  for (let m = 1; m <= Math.floor(TOTAL_MILES); m++) {
    const mc = getCoordAtDist(m);
    const mx = toX(mc[0]);
    const my = toY(mc[1]);
    const priority = (m % 10 === 0) ? 1 : (m % 5 === 0) ? 2 : 3;
    candidates.push({ mile: m, x: mx, y: my, priority: priority });
  }
  candidates.sort(function(a, b) { return a.priority - b.priority; });
  const placed = [];
  for (var ci = 0; ci < candidates.length; ci++) {
    var c = candidates[ci];
    var r = markerR + gap;
    var overlaps = false;
    for (var pi = 0; pi < placed.length; pi++) {
      var dx = c.x - placed[pi].x, dy = c.y - placed[pi].y;
      if (dx * dx + dy * dy < (r + markerR + gap) * (r + markerR + gap)) { overlaps = true; break; }
    }
    if (!overlaps) {
      ctx.beginPath();
      ctx.arc(c.x, c.y, markerR, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.fill();
      ctx.strokeStyle = c.priority === 1 ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.15)';
      ctx.lineWidth = c.priority === 1 ? 1.5 : 1;
      ctx.stroke();
      ctx.fillStyle = c.priority === 1 ? '#333' : '#555';
      ctx.font = (c.priority === 1 ? '700 ' : '600 ') + markerFont + 'px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(c.mile, c.x, c.y);
      placed.push(c);
    }
  }
}

// 
// SIMULATOR ELEVATION PROFILE - scrolling terrain with runner
// 
function renderSimProfile(currentDist, currentEle) {
  const canvas = document.getElementById('simProfileCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;

  // Windowed view centered on runner
  const windowMiles = Math.min(TOTAL_MILES, Math.max(6, TOTAL_MILES * 0.4));
  let windowStart = Math.max(0, currentDist - windowMiles * 0.35);
  const windowEnd = Math.min(TOTAL_MILES, windowStart + windowMiles);
  if (windowEnd - windowStart < windowMiles) windowStart = Math.max(0, windowEnd - windowMiles);

  // Sample points in view
  const pts = [];
  for (let i = 0; i < eleProfile.length; i++) {
    if (eleProfile[i].d >= windowStart && eleProfile[i].d <= windowStart + windowMiles) {
      pts.push(eleProfile[i]);
    }
  }
  if (pts.length < 2) return;

  const eles = pts.map(p => p.e);
  const eMin = Math.min(...eles) - 30;
  const eMax = Math.max(...eles) + 50;
  const mt = Math.min(30, H * 0.15), mb = 0;

  const xScale = d => ((d - windowStart) / windowMiles) * W;
  const yScale = e => mt + (H - mt - mb) - ((e - eMin) / (eMax - eMin)) * (H - mt - mb);

  // Sky gradient
  const elapsed = (currentDist / TOTAL_MILES) * simFinishHours;
  const tod = RACE_START_HOUR + elapsed;
  let skyTop, skyBot;
  if (tod < 6) { skyTop = '#c5cfd8'; skyBot = '#d8dfe6'; }
  else if (tod < 8) { skyTop = '#d0dae4'; skyBot = '#dde5ec'; }
  else if (tod < 17) { skyTop = '#dce6ed'; skyBot = '#e8ede9'; }
  else if (tod < 20) { skyTop = '#d5dce4'; skyBot = '#dde3de'; }
  else { skyTop = '#c5cfd8'; skyBot = '#d8dfe6'; }

  const skyGrad = ctx.createLinearGradient(0, 0, 0, H);
  skyGrad.addColorStop(0, skyTop);
  skyGrad.addColorStop(1, skyBot);
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, W, H);

  // Terrain fill
  ctx.beginPath();
  ctx.moveTo(xScale(pts[0].d), yScale(pts[0].e));
  for (const p of pts) ctx.lineTo(xScale(p.d), yScale(p.e));
  ctx.lineTo(xScale(pts[pts.length - 1].d), H);
  ctx.lineTo(xScale(pts[0].d), H);
  ctx.closePath();
  const tGrad = ctx.createLinearGradient(0, mt, 0, H);
  tGrad.addColorStop(0, 'rgba(46,125,50,0.3)');
  tGrad.addColorStop(1, 'rgba(46,125,50,0.05)');
  ctx.fillStyle = tGrad;
  ctx.fill();

  // Terrain line
  ctx.beginPath();
  ctx.moveTo(xScale(pts[0].d), yScale(pts[0].e));
  for (const p of pts) ctx.lineTo(xScale(p.d), yScale(p.e));
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 2.5;
  ctx.stroke();

  // Dim behind runner
  if (currentDist > windowStart) {
    ctx.fillStyle = 'rgba(200,210,200,0.35)';
    ctx.fillRect(0, 0, xScale(currentDist), H);
  }

  // Runner dot
  const rx = xScale(currentDist);
  const ry = yScale(currentEle);

  // Glow
  ctx.beginPath();
  ctx.arc(rx, ry, 12, 0, Math.PI * 2);
  const glow = ctx.createRadialGradient(rx, ry, 3, rx, ry, 12);
  glow.addColorStop(0, 'rgba(46,125,50,0.5)');
  glow.addColorStop(1, 'rgba(46,125,50,0)');
  ctx.fillStyle = glow;
  ctx.fill();

  ctx.beginPath();
  ctx.arc(rx, ry, 7, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 3;
  ctx.stroke();

  // Mile markers in view
  for (let m = Math.ceil(windowStart); m <= Math.floor(windowStart + windowMiles); m++) {
    if (m <= 0 || m >= TOTAL_MILES) continue;
    const mx = xScale(m);
    ctx.beginPath();
    ctx.moveTo(mx, mt);
    ctx.lineTo(mx, H);
    ctx.strokeStyle = 'rgba(0,0,0,0.06)';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.font = '9px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(m + ' mi', mx, mt - 8);
  }
}

// 
// INIT
// 
initMap();
mapInitialized = true;
window.addEventListener('load', drawElevationProfile);
window.addEventListener('resize', () => {
  drawElevationProfile();
  if (currentView === 'sim') renderSim();
});
</script>
</body>
</html>