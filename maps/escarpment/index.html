<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1a1a2e">
<title>Escarpment Trail Run 30K - Course Map</title>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #2E7D32;
  --primary-dark: #1B5E20;
  --accent: #1B5E20;
  --bg: #1a1a2e;
  --bg-card: #252540;
  --bg-alt: #16162a;
  --text: #ffffff;
  --text-secondary: #a0a0b0;
  --text-muted: #666680;
  --border: #333355;
  --course: #2E7D32;
  --shadow: 0 4px 20px rgba(0,0,0,0.3);
  --radius: 12px;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { font-size: 16px; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

.header {
  background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg) 100%);
  padding: 16px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-left h1 {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text);
  letter-spacing: 0.5px;
}
.header-left .subtitle {
  font-size: 0.7rem;
  color: var(--text-secondary);
  margin-top: 2px;
}
.header-left .subtitle a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
}
.race-badge {
  background: var(--primary);
  color: #fff;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.map-wrap { position: relative; }
#map { width: 100%; height: 55vh; min-height: 300px; }

.map-overlay {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 10;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.info-badge {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 10px 14px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
}
.info-badge .label {
  font-size: 0.6rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 2px;
}
.info-badge .value {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text);
}

.toggle-btns {
  position: absolute;
  top: 12px;
  right: 12px;
  z-index: 10;
  display: flex;
  gap: 6px;
}
.toggle-btn {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 0.7rem;
  font-weight: 600;
  font-family: inherit;
  color: var(--text-secondary);
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: all 0.2s;
}
.toggle-btn:hover { border-color: var(--primary); color: var(--text); }
.toggle-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

.stats-section {
  background: var(--bg-card);
  padding: 20px;
  border-bottom: 1px solid var(--border);
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  max-width: 600px;
  margin: 0 auto;
}
.stat-card {
  text-align: center;
  padding: 12px 8px;
  background: var(--bg-alt);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.stat-card .value {
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--primary);
}
.stat-card .label {
  font-size: 0.6rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-top: 4px;
}

.profile-section {
  background: var(--bg-alt);
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}
.profile-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.profile-header h3 {
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}
.profile-stats {
  display: flex;
  gap: 16px;
  font-size: 0.7rem;
  color: var(--text-secondary);
}
.profile-stats .val { font-weight: 600; color: var(--primary); }
#profileCanvas {
  width: 100%;
  height: 100px;
  display: block;
  background: var(--bg-card);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.course-info {
  padding: 20px;
  background: var(--bg-card);
  border-top: 1px solid var(--border);
}
.course-info h3 {
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}
.course-description {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.7;
}
.course-description strong {
  color: var(--text);
  font-weight: 600;
}

.footer {
  text-align: center;
  padding: 20px;
  font-size: 0.65rem;
  color: var(--text-muted);
  border-top: 1px solid var(--border);
}
.footer a { color: var(--primary); text-decoration: none; }

/* Mapbox customization */
.mapboxgl-popup-content {
  background: var(--bg-card) !important;
  color: var(--text) !important;
  border-radius: var(--radius) !important;
  padding: 12px 16px !important;
  box-shadow: var(--shadow) !important;
  font-family: inherit !important;
  font-size: 0.85rem !important;
  border: 1px solid var(--border) !important;
}
.mapboxgl-popup-tip { border-top-color: var(--bg-card) !important; }
.mapboxgl-popup-close-button { color: var(--text-muted) !important; font-size: 18px !important; }
.mapboxgl-ctrl-attrib { font-size: 9px !important; }
.mapboxgl-ctrl-group { border-radius: 8px !important; overflow: hidden; }

.start-marker {
  width: 32px;
  height: 32px;
  cursor: pointer;
}
.start-marker svg {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
}

/* View tabs */
.view-tabs {
  display: flex;
  gap: 4px;
  background: var(--bg-alt);
  padding: 3px;
  border-radius: 8px;
}
.view-tab {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  background: transparent;
  font-family: inherit;
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
}
.view-tab:active { transform: scale(0.96); }
.view-tab.active {
  background: var(--bg);
  color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.view { display: none; }
.view.active { display: block; }

/* Simulator */
.sim-container { background: var(--bg); }
.sim-split { display: flex; flex-direction: column; }

/* Course map canvas */
.course-map-wrap { position: relative; background: #1a2030; border-bottom: 1px solid var(--border); }
#courseMapCanvas { width: 100%; height: 260px; display: block; }
.runner-info-overlay {
  position: absolute; top: 12px; left: 12px; pointer-events: none;
}
.runner-ele {
  font-size: 1.8rem; font-weight: 700; color: #fff; line-height: 1;
  text-shadow: 0 2px 8px rgba(0,0,0,0.5);
}
.runner-ele .unit { font-size: 0.4em; font-weight: 400; opacity: 0.7; }
.runner-meta { font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-top: 2px; }

/* Sim elevation profile */
.sim-profile-wrap { position: relative; background: #1a2030; }
#simProfileCanvas { width: 100%; height: 140px; display: block; }

/* Scrubber */
.scrubber {
  background: var(--bg); padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}
.scrub-row { display: flex; align-items: center; gap: 12px; }
.play-btn {
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--primary); border: none; color: #fff;
  cursor: pointer; display: flex; align-items: center;
  justify-content: center; font-size: 14px; flex-shrink: 0;
  transition: all 0.15s;
}
.play-btn:active { transform: scale(0.95); background: var(--primary-dark); }
.scrub-track { flex: 1; position: relative; height: 36px; cursor: pointer; }
.scrub-bg {
  position: absolute; top: 14px; left: 0; right: 0; height: 8px;
  background: var(--bg-alt); border-radius: 4px; overflow: hidden;
}
.scrub-fill {
  position: absolute; top: 0; left: 0; height: 100%;
  background: var(--primary); opacity: 0.3; border-radius: 4px 0 0 4px;
}
.scrub-handle {
  position: absolute; top: 8px; width: 20px; height: 20px;
  background: var(--primary); border-radius: 50%; transform: translateX(-50%);
  box-shadow: 0 2px 6px rgba(46,125,50,0.4); pointer-events: none;
}
.speed-btns { display: flex; gap: 4px; flex-shrink: 0; }
.speed-btn {
  padding: 6px 10px; border-radius: 6px; background: var(--bg-alt);
  border: 1px solid var(--border); color: var(--text-muted);
  font-family: inherit; font-size: 0.7rem; font-weight: 600;
  cursor: pointer; transition: all 0.15s;
}
.speed-btn.active { background: var(--text); color: var(--bg); border-color: var(--text); }

/* Goal time */
.goal-time-bar {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 16px; background: var(--bg);
  border-bottom: 1px solid var(--border); flex-wrap: wrap;
}
.goal-label {
  font-size: 0.65rem; font-weight: 600; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px;
}
.goal-inputs { display: flex; align-items: center; gap: 4px; }
.goal-input {
  width: 48px; padding: 8px 4px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--bg-alt);
  color: var(--text); font-family: inherit; font-size: 1rem;
  font-weight: 600; text-align: center; outline: none;
}
.goal-input:focus { border-color: var(--primary); }
.goal-colon { font-size: 1.2rem; font-weight: 700; color: var(--text-muted); }
.goal-pace { font-size: 0.8rem; color: var(--text-secondary); margin-left: auto; }
.goal-pace strong { color: var(--text); font-weight: 600; }

/* Sim stats */
.sim-stats {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 1px; background: var(--border);
}
.sim-stat {
  background: var(--bg); padding: 12px 8px; text-align: center;
}
.sim-stat .val { font-size: 1.1rem; font-weight: 700; color: var(--text); }
.sim-stat .label {
  font-size: 0.6rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;
}

/* Clock */
.sim-clock {
  background: var(--bg); padding: 16px; text-align: center;
  border-bottom: 1px solid var(--border);
}
.clock-time { font-size: 2rem; font-weight: 700; color: var(--text); letter-spacing: 1px; }
.clock-label {
  font-size: 0.6rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px; margin-top: 2px;
}

@media (max-width: 600px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .stat-card .value { font-size: 1.2rem; }
  #map { height: 45vh; }
}
@media (min-width: 768px) {
  #courseMapCanvas { height: 320px; }
  #simProfileCanvas { height: 180px; }
  .sim-stats { grid-template-columns: repeat(6, 1fr); }
}
</style>
</head>
<body>

<header class="header">
  <div class="header-left">
    <h1>Escarpment Trail Run 30K</h1>
    <div class="subtitle">July 26, 2026 &bull; <a href="https://escarpmenttrailrun.com" target="_blank">Windham Mountain Running Club</a></div>
  </div>
  <div class="view-tabs">
    <button class="view-tab active" onclick="switchView('map')">Map</button>
    <button class="view-tab" onclick="switchView('sim')">Simulator</button>
  </div>
</header>

<div id="mapView" class="view active">

<div class="map-wrap">
  <div id="map"></div>
  <div class="map-overlay">
    <div class="info-badge">
      <div class="label">Start / Finish</div>
      <div class="value">Windham &#8594; Haines Falls</div>
    </div>
  </div>
  <div class="toggle-btns">
    <button class="toggle-btn active" id="courseBtn">Course</button>
    <button class="toggle-btn" id="trailBtn">Trails</button>
    <button class="toggle-btn" id="terrainBtn">3D</button>
  </div>
</div>

<section class="stats-section">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="value">18.6</div>
      <div class="label">Miles</div>
    </div>
    <div class="stat-card">
      <div class="value">~4,800</div>
      <div class="label">Elev Gain (ft)</div>
    </div>
    <div class="stat-card">
      <div class="value">30K</div>
      <div class="label">Distance</div>
    </div>
    <div class="stat-card">
      <div class="value">Point-to-Point</div>
      <div class="label">Course Type</div>
    </div>
  </div>
</section>

<section class="profile-section">
  <div class="profile-header">
    <h3>Elevation Profile</h3>
    <div class="profile-stats">
      <span>Gain: <span class="val">~4,800 ft</span></span>
      <span>High: <span class="val">3,930 ft</span></span>
    </div>
  </div>
  <canvas id="profileCanvas"></canvas>
</section>

<section class="course-info">
  <h3>Course Description</h3>
  <div class="course-description">
    <p>The <strong>Escarpment Trail Run</strong> is a legendary 30K point-to-point race through the heart of the <strong>Catskill Mountains</strong>. The course follows the rugged Escarpment Trail from <strong>Windham to Haines Falls</strong>, traversing multiple peaks above 3,500 feet with breathtaking views of the Hudson Valley. Known as one of the toughest trail races in the Northeast, runners face relentless climbs, technical rocky descents, and over <strong>4,800 feet of elevation gain</strong> across 18.6 miles.</p>
  </div>
</section>

</div><!-- end mapView -->

<div id="simView" class="view">
  <div class="sim-container">

    <div class="goal-time-bar">
      <span class="goal-label">Goal Time</span>
      <div class="goal-inputs">
        <input type="number" class="goal-input" id="goalHrs" min="0" max="48" value="4" onchange="updateGoalTime()" onclick="this.select()">
        <span class="goal-colon">:</span>
        <input type="number" class="goal-input" id="goalMins" min="0" max="59" value="0" onchange="updateGoalTime()" onclick="this.select()">
      </div>
      <div class="goal-pace" id="goalPace">Avg pace: <strong>12:54 /mi</strong></div>
    </div>

    <div class="course-map-wrap">
      <canvas id="courseMapCanvas"></canvas>
      <div class="runner-info-overlay">
        <div class="runner-ele" id="runnerEle">1,772<span class="unit">ft</span></div>
        <div class="runner-meta" id="runnerMeta">Mile 0.0 &middot; Starting</div>
      </div>
    </div>

    <div class="sim-profile-wrap">
      <canvas id="simProfileCanvas"></canvas>
    </div>

    <div class="scrubber">
      <div class="scrub-row">
        <button class="play-btn" id="playBtn" onclick="togglePlay()">&#9654;</button>
        <div class="scrub-track" id="scrubTrack">
          <div class="scrub-bg">
            <div class="scrub-fill" id="scrubFill"></div>
          </div>
          <div class="scrub-handle" id="scrubHandle"></div>
        </div>
        <div class="speed-btns">
          <button class="speed-btn active" onclick="setSpeed(1,this)">1x</button>
          <button class="speed-btn" onclick="setSpeed(2,this)">2x</button>
          <button class="speed-btn" onclick="setSpeed(4,this)">4x</button>
        </div>
      </div>
    </div>

    <div class="sim-clock">
      <div class="clock-time" id="clockTime">9:00 AM</div>
      <div class="clock-label">Current Time (Race starts 9:00 AM)</div>
      <div style="margin-top:8px;font-size:0.8rem;color:var(--text-secondary)">Finish: <strong id="finishTime" style="color:var(--primary)">1:00 PM</strong></div>
    </div>

    <div class="sim-stats">
      <div class="sim-stat"><div class="val" id="statDist">0.0</div><div class="label">Miles</div></div>
      <div class="sim-stat"><div class="val" id="statEle">0</div><div class="label">Elevation (ft)</div></div>
      <div class="sim-stat"><div class="val" id="statGain">0</div><div class="label">Gain (ft)</div></div>
      <div class="sim-stat"><div class="val" id="statGrade">0%</div><div class="label">Grade</div></div>
      <div class="sim-stat"><div class="val" id="statPace">--:--</div><div class="label">Pace /mi</div></div>
      <div class="sim-stat"><div class="val" id="statPct">0%</div><div class="label">Complete</div></div>
    </div>

  </div>
</div><!-- end simView -->

<footer class="footer">
  Escarpment Trail Run &bull; Produced by <a href="https://escarpmenttrailrun.com" target="_blank">Windham Mountain Running Club</a>
  <br>Interactive map powered by Mapbox
</footer>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibWljaGFlbHNwYXJrczEzIiwiYSI6ImNtbGp6cHNsNzA1OXEzam9iNWxkZnh6Y3AifQ.Z6IZuPPqMVcYTj1zP8AXYg';

const START_COORDS = [-74.18962, 42.31287];
const FINISH_COORDS = [-74.03642, 42.19621];

// Course data - truncated to 321 points (18.6 miles of the 23.2 mile GPX)
const COURSE_COORDS = [
  [-74.18962, 42.31287],[-74.18862, 42.31253],[-74.18808, 42.31183],[-74.18742, 42.31114],[-74.18716, 42.31059],
  [-74.18606, 42.31059],[-74.18499, 42.31042],[-74.18395, 42.31011],[-74.183, 42.30967],[-74.18193, 42.30951],
  [-74.18085, 42.30935],[-74.17976, 42.30917],[-74.1787, 42.30894],[-74.17764, 42.30871],[-74.17743, 42.30812],
  [-74.17709, 42.30793],[-74.17604, 42.3082],[-74.17617, 42.30761],[-74.17524, 42.30805],[-74.17427, 42.30831],
  [-74.17471, 42.30761],[-74.1754, 42.30696],[-74.17471, 42.30663],[-74.17364, 42.30679],[-74.17257, 42.30677],
  [-74.17173, 42.30726],[-74.17089, 42.30777],[-74.16998, 42.30821],[-74.16898, 42.30814],[-74.16797, 42.30803],
  [-74.167, 42.30841],[-74.16602, 42.30863],[-74.16524, 42.30906],[-74.16425, 42.30929],[-74.16322, 42.309],
  [-74.16213, 42.30897],[-74.16118, 42.3093],[-74.16021, 42.30965],[-74.1591, 42.30978],[-74.15799, 42.30975],
  [-74.15688, 42.30965],[-74.15586, 42.30956],[-74.1548, 42.30942],[-74.15394, 42.3089],[-74.15349, 42.30816],
  [-74.15299, 42.30747],[-74.15191, 42.30749],[-74.15087, 42.30743],[-74.14995, 42.30766],[-74.14967, 42.30842],
  [-74.14985, 42.30914],[-74.14974, 42.30994],[-74.14938, 42.31071],[-74.14863, 42.3113],[-74.14795, 42.31193],
  [-74.14724, 42.31256],[-74.14633, 42.31298],[-74.14582, 42.31368],[-74.14513, 42.31431],[-74.14432, 42.31473],
  [-74.14328, 42.31495],[-74.14245, 42.31484],[-74.14176, 42.31446],[-74.14086, 42.31417],[-74.13991, 42.31388],
  [-74.13881, 42.31389],[-74.13787, 42.31358],[-74.13717, 42.31312],[-74.13626, 42.31269],[-74.13538, 42.31222],
  [-74.13477, 42.31158],[-74.13446, 42.31082],[-74.1345, 42.31],[-74.13474, 42.30924],[-74.13429, 42.3085],
  [-74.1335, 42.30795],[-74.13265, 42.30745],[-74.13182, 42.307],[-74.13076, 42.30702],[-74.12995, 42.30649],
  [-74.12919, 42.30595],[-74.12889, 42.30518],[-74.12859, 42.30441],[-74.12812, 42.30369],[-74.12734, 42.30338],
  [-74.12628, 42.30357],[-74.12525, 42.3039],[-74.12417, 42.30414],[-74.12315, 42.30396],[-74.12238, 42.30346],
  [-74.12156, 42.30349],[-74.1214, 42.30288],[-74.12102, 42.30216],[-74.12038, 42.30149],[-74.11944, 42.3011],
  [-74.11842, 42.3008],[-74.11753, 42.30046],[-74.11646, 42.3002],[-74.11539, 42.30029],[-74.11445, 42.30068],
  [-74.11427, 42.30115],[-74.11371, 42.30068],[-74.11281, 42.30047],[-74.11173, 42.30061],[-74.11064, 42.30067],
  [-74.1097, 42.30062],[-74.10913, 42.30069],[-74.10819, 42.30074],[-74.10726, 42.30051],[-74.10637, 42.30011],
  [-74.10639, 42.29981],[-74.10558, 42.29947],[-74.10466, 42.29899],[-74.10399, 42.29846],[-74.10295, 42.29821],
  [-74.10222, 42.29767],[-74.10133, 42.29735],[-74.10037, 42.29716],[-74.09972, 42.29652],[-74.09948, 42.29573],
  [-74.09979, 42.29495],[-74.10002, 42.29413],[-74.09998, 42.29332],[-74.10056, 42.29264],[-74.10122, 42.29197],
  [-74.10159, 42.29121],[-74.10166, 42.29042],[-74.10146, 42.28963],[-74.10128, 42.28882],[-74.10079, 42.28816],
  [-74.10004, 42.28761],[-74.09929, 42.28702],[-74.09861, 42.2864],[-74.09865, 42.28566],[-74.09929, 42.28501],
  [-74.09964, 42.28423],[-74.09946, 42.28342],[-74.09885, 42.28276],[-74.09842, 42.28216],[-74.09801, 42.28141],
  [-74.09772, 42.28061],[-74.09728, 42.2799],[-74.09758, 42.27917],[-74.09821, 42.27855],[-74.09777, 42.27803],
  [-74.09751, 42.27726],[-74.09783, 42.27649],[-74.09803, 42.27572],[-74.09829, 42.27502],[-74.09828, 42.27421],
  [-74.09877, 42.27356],[-74.09899, 42.27277],[-74.09898, 42.27209],[-74.09875, 42.27141],[-74.09876, 42.27067],
  [-74.09916, 42.2701],[-74.09941, 42.26987],[-74.10017, 42.26945],[-74.10088, 42.26924],[-74.10177, 42.26881],
  [-74.10269, 42.26902],[-74.10343, 42.26881],[-74.10366, 42.26829],[-74.10446, 42.26788],[-74.10418, 42.26747],
  [-74.10372, 42.26681],[-74.10322, 42.26619],[-74.10252, 42.26569],[-74.10167, 42.26556],[-74.1007, 42.26532],
  [-74.09975, 42.26493],[-74.09889, 42.26445],[-74.09803, 42.26395],[-74.09709, 42.26352],[-74.09607, 42.26325],
  [-74.09502, 42.26313],[-74.09391, 42.26312],[-74.09285, 42.26286],[-74.09201, 42.26238],[-74.09159, 42.2616],
  [-74.09116, 42.26086],[-74.09103, 42.26007],[-74.09067, 42.25932],[-74.08988, 42.25921],[-74.08884, 42.25893],
  [-74.08773, 42.25874],[-74.08662, 42.25861],[-74.08558, 42.25841],[-74.08487, 42.25778],[-74.08421, 42.25714],
  [-74.08353, 42.25648],[-74.08304, 42.25578],[-74.08302, 42.25499],[-74.08342, 42.25422],[-74.08376, 42.25344],
  [-74.08372, 42.25265],[-74.08315, 42.25195],[-74.08206, 42.25196],[-74.0811, 42.25231],[-74.08038, 42.25182],
  [-74.07981, 42.25141],[-74.07917, 42.25162],[-74.07888, 42.251],[-74.0793, 42.25024],[-74.07927, 42.24977],
  [-74.07834, 42.24995],[-74.0773, 42.25006],[-74.07626, 42.24977],[-74.07549, 42.24923],[-74.07539, 42.24859],
  [-74.07511, 42.2479],[-74.07451, 42.2472],[-74.07389, 42.24655],[-74.07361, 42.24575],[-74.07301, 42.24508],
  [-74.07231, 42.2445],[-74.07168, 42.24383],[-74.07148, 42.24299],[-74.07102, 42.24225],[-74.07069, 42.24145],
  [-74.07031, 42.24069],[-74.07025, 42.2399],[-74.07031, 42.23911],[-74.07068, 42.23842],[-74.07062, 42.23812],
  [-74.0701, 42.2375],[-74.07016, 42.23688],[-74.07048, 42.23631],[-74.07016, 42.23557],[-74.07042, 42.23484],
  [-74.07039, 42.23402],[-74.07002, 42.23323],[-74.06955, 42.2325],[-74.06909, 42.23174],[-74.06844, 42.2311],
  [-74.0678, 42.23041],[-74.06711, 42.22976],[-74.06655, 42.22903],[-74.06586, 42.2284],[-74.06544, 42.22765],
  [-74.06504, 42.22693],[-74.06457, 42.22625],[-74.06472, 42.22563],[-74.06578, 42.22534],[-74.06552, 42.22487],
  [-74.06441, 42.22487],[-74.06367, 42.22495],[-74.06302, 42.22467],[-74.06206, 42.22436],[-74.0614, 42.22375],
  [-74.06054, 42.22328],[-74.05959, 42.22281],[-74.05881, 42.22225],[-74.05785, 42.22188],[-74.05693, 42.22159],
  [-74.05596, 42.22123],[-74.05519, 42.2206],[-74.05478, 42.21983],[-74.05445, 42.21906],[-74.05358, 42.21854],
  [-74.05294, 42.21833],[-74.05192, 42.21825],[-74.05092, 42.21858],[-74.04994, 42.21881],[-74.04891, 42.21902],
  [-74.04784, 42.21923],[-74.04675, 42.21932],[-74.04591, 42.21879],[-74.04518, 42.21867],[-74.04442, 42.21919],
  [-74.04369, 42.21975],[-74.04329, 42.2197],[-74.04268, 42.22028],[-74.04194, 42.22042],[-74.04097, 42.22019],
  [-74.0404, 42.21999],[-74.03958, 42.21956],[-74.03975, 42.21892],[-74.03996, 42.21858],[-74.03996, 42.21807],
  [-74.03907, 42.21755],[-74.03825, 42.21698],[-74.03718, 42.21672],[-74.03643, 42.21722],[-74.03585, 42.21714],
  [-74.03563, 42.21637],[-74.03543, 42.21557],[-74.03563, 42.21494],[-74.03516, 42.21462],[-74.03478, 42.21393],
  [-74.03435, 42.21461],[-74.03374, 42.214],[-74.03377, 42.2132],[-74.03345, 42.21272],[-74.03237, 42.21266],
  [-74.03177, 42.21233],[-74.03131, 42.21161],[-74.03092, 42.21085],[-74.03064, 42.21006],[-74.03097, 42.20932],
  [-74.03123, 42.20854],[-74.03107, 42.20781],[-74.03128, 42.207],[-74.03118, 42.20624],[-74.0311, 42.20542],
  [-74.03056, 42.20472],[-74.03024, 42.20394],[-74.03038, 42.20323],[-74.03038, 42.20245],[-74.02954, 42.20214],
  [-74.02986, 42.2015],[-74.0305, 42.20086],[-74.031, 42.2002],[-74.03121, 42.19942],[-74.03195, 42.19883],
  [-74.03275, 42.19835],[-74.03367, 42.19786],[-74.03459, 42.19735],[-74.03477, 42.19656],[-74.0354, 42.19612],
  [-74.03642, 42.19621]
];

// Elevation data (meters, sampled from GPX) - truncated to 321 points
const ELEVATIONS = [
  540, 541, 541, 546, 553, 562, 565, 573, 583, 592, 598, 607, 617, 627, 638, 650, 659, 666, 672, 675,
  688, 697, 706, 710, 721, 740, 752, 761, 773, 781, 788, 797, 812, 822, 827, 828, 835, 844, 845, 847,
  846, 860, 869, 885, 900, 911, 928, 930, 943, 959, 983, 994, 1013, 1021, 1031, 1042, 1042, 1053, 1067, 1070,
  1074, 1058, 1045, 1028, 1007, 994, 982, 965, 949, 936, 936, 932, 933, 928, 932, 937, 930, 905, 887, 886,
  903, 921, 925, 912, 899, 900, 906, 907, 903, 917, 931, 934, 935, 931, 930, 924, 929, 930, 920, 903,
  895, 886, 863, 847, 843, 851, 874, 889, 907, 907, 909, 912, 912, 916, 930, 937, 939, 941, 935, 923,
  921, 924, 925, 921, 917, 913, 909, 914, 913, 898, 893, 894, 899, 905, 911, 908, 905, 904, 904, 904,
  904, 903, 903, 896, 890, 884, 875, 873, 879, 891, 918, 944, 963, 960, 969, 985, 997, 1023, 1047, 1077,
  1099, 1129, 1169, 1189, 1198, 1191, 1183, 1166, 1135, 1097, 1072, 1048, 1036, 1037, 1034, 1023, 1017, 1009, 1011, 1009,
  1012, 1021, 1034, 1039, 1033, 1027, 1022, 1020, 1016, 1015, 1019, 1015, 1002, 990, 975, 965, 960, 963, 962, 930,
  895, 872, 855, 842, 827, 818, 802, 779, 762, 776, 797, 820, 838, 848, 855, 855, 852, 847, 839, 834,
  830, 832, 844, 863, 875, 898, 916, 941, 941, 954, 963, 962, 963, 965, 961, 963, 963, 967, 969, 983,
  1003, 1028, 1037, 1037, 1036, 1037, 1035, 1019, 1004, 998, 985, 980, 977, 970, 964, 956, 953, 954, 953, 955,
  954, 961, 955, 950, 942, 941, 951, 959, 954, 944, 936, 936, 929, 922, 917, 909, 885, 864, 844, 828,
  825, 828, 832, 831, 827, 828, 826, 823, 818, 802, 792, 790, 786, 780, 754, 743, 744, 749, 741, 749,
  757, 736, 743, 734, 731, 729, 728, 718, 706, 674, 680, 687, 680, 666, 663, 659, 653, 652, 652, 657,
  665
];

const COURSE = {
  type: 'Feature',
  properties: {
    name: 'Escarpment Trail Run 30K',
    distance_mi: 18.6
  },
  geometry: {
    type: 'LineString',
    coordinates: COURSE_COORDS
  }
};

let map;
let courseVisible = true;
let terrain3D = false;
let trailsOn = false;
let trailsData = null;

function initMap() {
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/outdoors-v12',
    center: [-74.1096, 42.2495],
    zoom: 11,
    pitch: 0
  });

  map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

  map.on('load', () => {
    // Add course line
    map.addSource('course', { type: 'geojson', data: COURSE });
    map.addLayer({
      id: 'course-outline',
      type: 'line',
      source: 'course',
      paint: {
        'line-color': '#000',
        'line-width': 7,
        'line-opacity': 0.3
      }
    });
    map.addLayer({
      id: 'course-line',
      type: 'line',
      source: 'course',
      paint: {
        'line-color': '#2E7D32',
        'line-width': 4
      }
    });

    // Add start marker
    const startEl = document.createElement('div');
    startEl.className = 'start-marker';
    startEl.innerHTML = '<svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="#2E7D32" stroke="#fff" stroke-width="2"/><text x="16" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff">S</text></svg>';
    new mapboxgl.Marker({ element: startEl })
      .setLngLat(START_COORDS)
      .setPopup(new mapboxgl.Popup({ offset: 15 }).setHTML('<strong style="color:#2E7D32">Start - Windham, NY</strong><br><span style="color:#a0a0b0">Escarpment Trail Run 30K</span>'))
      .addTo(map);

    // Add finish marker
    const finishEl = document.createElement('div');
    finishEl.className = 'start-marker';
    finishEl.innerHTML = '<svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="#2E7D32" stroke="#fff" stroke-width="2"/><text x="16" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff">F</text></svg>';
    new mapboxgl.Marker({ element: finishEl })
      .setLngLat(FINISH_COORDS)
      .setPopup(new mapboxgl.Popup({ offset: 15 }).setHTML('<strong style="color:#2E7D32">Finish - Haines Falls, NY</strong><br><span style="color:#a0a0b0">Escarpment Trail Run 30K</span>'))
      .addTo(map);

    // Add course click interaction
    map.on('click', 'course-line', e => {
      new mapboxgl.Popup({ offset: 12 })
        .setLngLat(e.lngLat)
        .setHTML('<strong style="color:#2E7D32">Escarpment Trail Run 30K</strong><br><span style="color:#a0a0b0">18.6 mi &bull; ~4,800 ft gain</span>')
        .addTo(map);
    });
    map.on('mouseenter', 'course-line', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'course-line', () => map.getCanvas().style.cursor = '');

    // Fit to course bounds
    const bounds = new mapboxgl.LngLatBounds();
    COURSE_COORDS.forEach(coord => bounds.extend(coord));
    map.fitBounds(bounds, { padding: 40 });
  });
}

function toggleCourse() {
  courseVisible = !courseVisible;
  document.getElementById('courseBtn').classList.toggle('active', courseVisible);
  if (map.getLayer('course-line')) {
    map.setLayoutProperty('course-line', 'visibility', courseVisible ? 'visible' : 'none');
    map.setLayoutProperty('course-outline', 'visibility', courseVisible ? 'visible' : 'none');
  }
}

function toggle3D() {
  terrain3D = !terrain3D;
  document.getElementById('terrainBtn').classList.toggle('active', terrain3D);
  if (terrain3D) {
    if (!map.getSource('mapbox-dem')) {
      map.addSource('mapbox-dem', { type: 'raster-dem', url: 'mapbox://mapbox.mapbox-terrain-dem-v1', tileSize: 512, maxzoom: 14 });
    }
    map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });
    map.easeTo({ pitch: 45, duration: 1000 });
  } else {
    map.setTerrain(null);
    map.easeTo({ pitch: 0, duration: 1000 });
  }
}

function toggleTrails() {
  trailsOn = !trailsOn;
  document.getElementById('trailBtn').classList.toggle('active', trailsOn);
  if (!map) return;

  if (trailsOn) {
    if (!map.getSource('park-trails')) {
      if (trailsData) {
        addTrailLayers();
      } else {
        fetch('data/trails.geojson')
          .then(r => r.json())
          .then(data => { trailsData = data; addTrailLayers(); });
        return;
      }
    }
    map.setLayoutProperty('park-trails-line', 'visibility', 'visible');
    map.setLayoutProperty('park-trails-label', 'visibility', 'visible');
  } else {
    if (map.getLayer('park-trails-line')) map.setLayoutProperty('park-trails-line', 'visibility', 'none');
    if (map.getLayer('park-trails-label')) map.setLayoutProperty('park-trails-label', 'visibility', 'none');
  }
}

function addTrailLayers() {
  if (!map.getSource('park-trails')) {
    map.addSource('park-trails', { type: 'geojson', data: trailsData });
  }
  if (!map.getLayer('park-trails-line')) {
    map.addLayer({
      id: 'park-trails-line',
      type: 'line',
      source: 'park-trails',
      paint: {
        'line-color': ['match', ['get', 'blaze'],
          'white', '#ffffff',
          'blue', '#2196F3',
          'yellow', '#FFD700',
          'orange', '#FF9800',
          'green', '#4CAF50',
          'red', '#f44336',
          'violet', '#9C27B0',
          '#9E9E9E'
        ],
        'line-width': ['interpolate', ['linear'], ['zoom'], 12, 1.5, 15, 3],
        'line-opacity': 0.85
      },
      layout: { 'line-cap': 'round', 'line-join': 'round' }
    }, 'course-outline');
  }
  if (!map.getLayer('park-trails-label')) {
    map.addLayer({
      id: 'park-trails-label',
      type: 'symbol',
      source: 'park-trails',
      layout: {
        'symbol-placement': 'line',
        'text-field': ['get', 'name'],
        'text-size': ['interpolate', ['linear'], ['zoom'], 13, 9, 16, 12],
        'text-font': ['DIN Pro Medium', 'Arial Unicode MS Regular'],
        'text-max-angle': 30,
        'text-padding': 10
      },
      paint: {
        'text-color': '#333',
        'text-halo-color': '#fff',
        'text-halo-width': 1.5,
        'text-opacity': ['interpolate', ['linear'], ['zoom'], 13, 0, 13.5, 1]
      },
      minzoom: 13
    });
  }
}

function drawElevationProfile() {
  const canvas = document.getElementById('profileCanvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);

  const w = rect.width;
  const h = rect.height;
  const padding = { top: 10, right: 10, bottom: 25, left: 40 };
  const chartW = w - padding.left - padding.right;
  const chartH = h - padding.top - padding.bottom;

  const maxDist = 18.6;
  const maxEle = 1250; // meters (~4,100 ft)
  const minEle = 500;  // meters (~1,640 ft)

  // Draw grid
  ctx.strokeStyle = '#333355';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = padding.top + (chartH / 4) * i;
    ctx.beginPath();
    ctx.moveTo(padding.left, y);
    ctx.lineTo(w - padding.right, y);
    ctx.stroke();
  }

  // Draw elevation area
  ctx.beginPath();
  ctx.moveTo(padding.left, padding.top + chartH);
  ELEVATIONS.forEach((ele, i) => {
    const x = padding.left + (i / (ELEVATIONS.length - 1)) * chartW;
    const y = padding.top + chartH - ((ele - minEle) / (maxEle - minEle)) * chartH;
    if (i === 0) ctx.lineTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.lineTo(padding.left + chartW, padding.top + chartH);
  ctx.closePath();
  const gradient = ctx.createLinearGradient(0, padding.top, 0, padding.top + chartH);
  gradient.addColorStop(0, 'rgba(46, 125, 50, 0.4)');
  gradient.addColorStop(1, 'rgba(46, 125, 50, 0.05)');
  ctx.fillStyle = gradient;
  ctx.fill();

  // Draw elevation line
  ctx.beginPath();
  ELEVATIONS.forEach((ele, i) => {
    const x = padding.left + (i / (ELEVATIONS.length - 1)) * chartW;
    const y = padding.top + chartH - ((ele - minEle) / (maxEle - minEle)) * chartH;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Draw labels
  ctx.fillStyle = '#666680';
  ctx.font = '10px Inter, sans-serif';
  ctx.textAlign = 'center';
  for (let m = 0; m <= 18; m += 3) {
    const x = padding.left + (m / maxDist) * chartW;
    ctx.fillText(m + ' mi', x, h - 8);
  }
  ctx.textAlign = 'right';
  // Convert meters to feet for display
  const minFt = Math.round(minEle * 3.28084);
  const midEle = (minEle + maxEle) / 2;
  const midFt = Math.round(midEle * 3.28084);
  const maxFt = Math.round(maxEle * 3.28084);
  ctx.fillText(minFt.toLocaleString() + ' ft', padding.left - 5, padding.top + chartH);
  ctx.fillText(midFt.toLocaleString() + ' ft', padding.left - 5, padding.top + chartH / 2);
  ctx.fillText(maxFt.toLocaleString() + ' ft', padding.left - 5, padding.top + 10);
}

document.getElementById('courseBtn').onclick = toggleCourse;
document.getElementById('trailBtn').onclick = toggleTrails;
document.getElementById('terrainBtn').onclick = toggle3D;

// ═══════════════════════════════════════════════════════════
// VIEW SWITCHING
// ═══════════════════════════════════════════════════════════
let currentView = 'map';
let mapInitialized = false;
let simInitialized = false;

function switchView(view) {
  currentView = view;
  document.querySelectorAll('.view-tab').forEach(t => t.classList.toggle('active', t.textContent.toLowerCase() === view));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(view + 'View').classList.add('active');
  if (view === 'map' && !mapInitialized) {
    initMap();
    mapInitialized = true;
  }
  if (view === 'sim') {
    initSim();
    renderSim();
  }
}

// ═══════════════════════════════════════════════════════════
// SIMULATOR
// ═══════════════════════════════════════════════════════════
const TOTAL_MILES = 18.6;
const TOTAL_GAIN = 4800; // feet (approximate)
const RACE_START_HOUR = 9; // 9:00 AM
let simProgress = 0;
let simPlaying = false;
let simSpeed = 1;
let simFinishHours = 4.0;
let simLastTick = 0;

// Build distance array for each coordinate (cumulative miles)
const coordDistances = [0];
for (let i = 1; i < COURSE_COORDS.length; i++) {
  const [x1, y1] = COURSE_COORDS[i - 1];
  const [x2, y2] = COURSE_COORDS[i];
  const dLng = (x2 - x1) * Math.cos((y1 + y2) / 2 * Math.PI / 180) * 69.172;
  const dLat = (y2 - y1) * 69.172;
  coordDistances.push(coordDistances[i - 1] + Math.sqrt(dLng * dLng + dLat * dLat));
}
// Normalize to actual total miles
const rawTotal = coordDistances[coordDistances.length - 1];
for (let i = 0; i < coordDistances.length; i++) {
  coordDistances[i] = (coordDistances[i] / rawTotal) * TOTAL_MILES;
}

// Build elevation profile indexed by distance (in feet)
const eleProfile = ELEVATIONS.map((e, i) => ({
  d: (i / (ELEVATIONS.length - 1)) * TOTAL_MILES,
  e: e * 3.28084 // meters to feet
}));

function getEleAtDist(dist) {
  for (let i = 1; i < eleProfile.length; i++) {
    if (eleProfile[i].d >= dist) {
      const p0 = eleProfile[i - 1], p1 = eleProfile[i];
      const t = (dist - p0.d) / (p1.d - p0.d);
      return p0.e + (p1.e - p0.e) * t;
    }
  }
  return eleProfile[eleProfile.length - 1].e;
}

function getGradeAtDist(dist) {
  const delta = 0.05;
  const e1 = getEleAtDist(Math.max(0, dist - delta));
  const e2 = getEleAtDist(Math.min(TOTAL_MILES, dist + delta));
  const dDist = delta * 2 * 5280;
  return dDist > 0 ? ((e2 - e1) / dDist) * 100 : 0;
}

function getGainAtDist(dist) {
  return (dist / TOTAL_MILES) * TOTAL_GAIN;
}

function getCoordAtDist(dist) {
  for (let i = 1; i < coordDistances.length; i++) {
    if (coordDistances[i] >= dist) {
      const t = (dist - coordDistances[i - 1]) / (coordDistances[i] - coordDistances[i - 1]);
      const c0 = COURSE_COORDS[i - 1], c1 = COURSE_COORDS[i];
      return [c0[0] + (c1[0] - c0[0]) * t, c0[1] + (c1[1] - c0[1]) * t];
    }
  }
  return COURSE_COORDS[COURSE_COORDS.length - 1];
}

function initSim() {
  if (simInitialized) return;
  simInitialized = true;
  updateGoalPace();

  // Scrubber interaction
  const track = document.getElementById('scrubTrack');
  let scrubbing = false;
  const scrubTo = e => {
    const rect = track.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    simProgress = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
    renderSim();
  };
  track.addEventListener('mousedown', e => { scrubbing = true; simPlaying = false; document.getElementById('playBtn').innerHTML = '&#9654;'; scrubTo(e); });
  window.addEventListener('mousemove', e => { if (scrubbing) scrubTo(e); });
  window.addEventListener('mouseup', () => scrubbing = false);
  track.addEventListener('touchstart', e => { scrubbing = true; simPlaying = false; document.getElementById('playBtn').innerHTML = '&#9654;'; scrubTo(e); }, { passive: true });
  window.addEventListener('touchmove', e => { if (scrubbing) scrubTo(e); }, { passive: true });
  window.addEventListener('touchend', () => scrubbing = false);
}

function updateGoalTime() {
  const h = parseInt(document.getElementById('goalHrs').value) || 0;
  const m = parseInt(document.getElementById('goalMins').value) || 0;
  simFinishHours = h + m / 60;
  if (simFinishHours < 0.1) simFinishHours = 0.1;
  updateGoalPace();
  renderSim();
}

function updateGoalPace() {
  const totalMins = simFinishHours * 60;
  const paceMin = totalMins / TOTAL_MILES;
  const pm = Math.floor(paceMin);
  const ps = Math.round((paceMin - pm) * 60);
  document.getElementById('goalPace').innerHTML = 'Avg pace: <strong>' + pm + ':' + String(ps).padStart(2, '0') + ' /mi</strong>';
}

function togglePlay() {
  simPlaying = !simPlaying;
  document.getElementById('playBtn').innerHTML = simPlaying ? '&#9208;' : '&#9654;';
  if (simPlaying) {
    if (simProgress >= 0.999) simProgress = 0;
    simLastTick = performance.now();
    simTick();
  }
}

function setSpeed(s, btn) {
  simSpeed = s;
  document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function simTick() {
  if (!simPlaying) return;
  const now = performance.now();
  const dt = (now - simLastTick) / 1000;
  simLastTick = now;
  simProgress = Math.min(1, simProgress + (1 / 30) * simSpeed * dt);
  renderSim();
  if (simProgress >= 1) {
    simPlaying = false;
    document.getElementById('playBtn').innerHTML = '&#9654;';
    return;
  }
  requestAnimationFrame(simTick);
}

function renderSim() {
  const dist = simProgress * TOTAL_MILES;
  const ele = getEleAtDist(dist);
  const grade = getGradeAtDist(dist);
  const gain = getGainAtDist(dist);

  // Scrubber
  document.getElementById('scrubFill').style.width = (simProgress * 100) + '%';
  document.getElementById('scrubHandle').style.left = (simProgress * 100) + '%';

  // Runner info
  document.getElementById('runnerEle').innerHTML = Math.round(ele).toLocaleString() + '<span class="unit">ft</span>';
  const gradeDir = grade > 2 ? 'Climbing' : grade < -2 ? 'Descending' : 'Rolling';
  document.getElementById('runnerMeta').textContent = 'Mile ' + dist.toFixed(1) + ' \u00b7 ' + gradeDir;

  // Clock
  const elapsed = (dist / TOTAL_MILES) * simFinishHours;
  const tod = RACE_START_HOUR + elapsed;
  const hrs = Math.floor(tod) % 24;
  const mins = Math.floor((tod % 1) * 60);
  const ampm = hrs >= 12 ? 'PM' : 'AM';
  const dispHrs = hrs > 12 ? hrs - 12 : (hrs === 0 ? 12 : hrs);
  document.getElementById('clockTime').textContent = dispHrs + ':' + String(mins).padStart(2, '0') + ' ' + ampm;

  const finishTod = RACE_START_HOUR + simFinishHours;
  const finishHrs = Math.floor(finishTod) % 24;
  const finishMins = Math.round((finishTod % 1) * 60);
  const finishAmpm = finishHrs >= 12 ? 'PM' : 'AM';
  const finishDispHrs = finishHrs > 12 ? finishHrs - 12 : (finishHrs === 0 ? 12 : finishHrs);
  document.getElementById('finishTime').textContent = finishDispHrs + ':' + String(finishMins).padStart(2, '0') + ' ' + finishAmpm;

  // Stats
  document.getElementById('statDist').textContent = dist.toFixed(1);
  document.getElementById('statEle').textContent = Math.round(ele).toLocaleString();
  document.getElementById('statGain').textContent = Math.round(gain).toLocaleString();
  document.getElementById('statGrade').textContent = (grade > 0 ? '+' : '') + grade.toFixed(0) + '%';
  document.getElementById('statPct').textContent = Math.round(simProgress * 100) + '%';

  // Pace
  const totalMins = simFinishHours * 60;
  const paceMin = totalMins / TOTAL_MILES;
  const pm = Math.floor(paceMin);
  const ps = Math.round((paceMin - pm) * 60);
  document.getElementById('statPace').textContent = pm + ':' + String(ps).padStart(2, '0');

  // Draw canvases
  renderCourseMap(dist);
  renderSimProfile(dist, ele);
}

// ═══════════════════════════════════════════════════════════
// COURSE MAP CANVAS - bird's-eye view of the course with runner dot
// ═══════════════════════════════════════════════════════════
function renderCourseMap(currentDist) {
  const canvas = document.getElementById('courseMapCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;

  // Background
  const bgGrad = ctx.createLinearGradient(0, 0, 0, H);
  bgGrad.addColorStop(0, '#1a2030');
  bgGrad.addColorStop(1, '#252540');
  ctx.fillStyle = bgGrad;
  ctx.fillRect(0, 0, W, H);

  // Compute bounding box of course
  let minLng = Infinity, maxLng = -Infinity, minLat = Infinity, maxLat = -Infinity;
  for (const [lng, lat] of COURSE_COORDS) {
    if (lng < minLng) minLng = lng;
    if (lng > maxLng) maxLng = lng;
    if (lat < minLat) minLat = lat;
    if (lat > maxLat) maxLat = lat;
  }
  const padding = 30;
  const drawW = W - padding * 2;
  const drawH = H - padding * 2;
  const lngRange = maxLng - minLng;
  const latRange = maxLat - minLat;
  const scale = Math.min(drawW / lngRange, drawH / latRange);
  const offsetX = padding + (drawW - lngRange * scale) / 2;
  const offsetY = padding + (drawH - latRange * scale) / 2;

  const toX = lng => offsetX + (lng - minLng) * scale;
  const toY = lat => offsetY + (maxLat - lat) * scale; // flip Y

  // Draw completed portion (bright)
  const runnerCoord = getCoordAtDist(currentDist);
  let runnerIdx = 0;
  for (let i = 1; i < coordDistances.length; i++) {
    if (coordDistances[i] >= currentDist) { runnerIdx = i; break; }
  }

  // Draw trail shadow (full course, dim)
  ctx.beginPath();
  for (let i = 0; i < COURSE_COORDS.length; i++) {
    const x = toX(COURSE_COORDS[i][0]);
    const y = toY(COURSE_COORDS[i][1]);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 6;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.stroke();

  // Draw remaining portion (dim green)
  ctx.beginPath();
  for (let i = Math.max(0, runnerIdx - 1); i < COURSE_COORDS.length; i++) {
    const x = toX(COURSE_COORDS[i][0]);
    const y = toY(COURSE_COORDS[i][1]);
    if (i === Math.max(0, runnerIdx - 1)) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.strokeStyle = 'rgba(46,125,50,0.2)';
  ctx.lineWidth = 3;
  ctx.stroke();

  // Draw completed portion (bright green)
  if (runnerIdx > 0) {
    ctx.beginPath();
    for (let i = 0; i <= Math.min(runnerIdx, COURSE_COORDS.length - 1); i++) {
      const x = toX(COURSE_COORDS[i][0]);
      const y = toY(COURSE_COORDS[i][1]);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    // Also draw to exact runner position
    const rx = toX(runnerCoord[0]);
    const ry = toY(runnerCoord[1]);
    ctx.lineTo(rx, ry);
    ctx.strokeStyle = '#2E7D32';
    ctx.lineWidth = 3;
    ctx.stroke();
  }

  // Start marker
  const sx = toX(COURSE_COORDS[0][0]);
  const sy = toY(COURSE_COORDS[0][1]);
  ctx.beginPath();
  ctx.arc(sx, sy, 6, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.fillStyle = '#2E7D32';
  ctx.font = 'bold 8px Inter, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('S', sx, sy + 0.5);

  // Finish marker
  const fx = toX(COURSE_COORDS[COURSE_COORDS.length - 1][0]);
  const fy = toY(COURSE_COORDS[COURSE_COORDS.length - 1][1]);
  ctx.beginPath();
  ctx.arc(fx, fy, 6, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.fillStyle = '#2E7D32';
  ctx.font = 'bold 8px Inter, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('F', fx, fy + 0.5);

  // Runner dot
  const rx = toX(runnerCoord[0]);
  const ry = toY(runnerCoord[1]);

  // Glow
  ctx.beginPath();
  ctx.arc(rx, ry, 14, 0, Math.PI * 2);
  const glow = ctx.createRadialGradient(rx, ry, 4, rx, ry, 14);
  glow.addColorStop(0, 'rgba(46,125,50,0.4)');
  glow.addColorStop(1, 'rgba(46,125,50,0)');
  ctx.fillStyle = glow;
  ctx.fill();

  // Dot
  ctx.beginPath();
  ctx.arc(rx, ry, 7, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 3;
  ctx.stroke();

  // Mile markers every 5 miles
  for (let m = 5; m < TOTAL_MILES; m += 5) {
    const mc = getCoordAtDist(m);
    const mx = toX(mc[0]);
    const my = toY(mc[1]);
    ctx.beginPath();
    ctx.arc(mx, my, 10, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(37,37,64,0.85)';
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.fillStyle = 'rgba(255,255,255,0.7)';
    ctx.font = '600 8px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(m, mx, my);
  }
}

// ═══════════════════════════════════════════════════════════
// SIMULATOR ELEVATION PROFILE - scrolling terrain with runner
// ═══════════════════════════════════════════════════════════
function renderSimProfile(currentDist, currentEle) {
  const canvas = document.getElementById('simProfileCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;

  // Windowed view centered on runner
  const windowMiles = Math.min(TOTAL_MILES, Math.max(6, TOTAL_MILES * 0.4));
  let windowStart = Math.max(0, currentDist - windowMiles * 0.35);
  const windowEnd = Math.min(TOTAL_MILES, windowStart + windowMiles);
  if (windowEnd - windowStart < windowMiles) windowStart = Math.max(0, windowEnd - windowMiles);

  // Sample points in view
  const pts = [];
  for (let i = 0; i < eleProfile.length; i++) {
    if (eleProfile[i].d >= windowStart && eleProfile[i].d <= windowStart + windowMiles) {
      pts.push(eleProfile[i]);
    }
  }
  if (pts.length < 2) return;

  const eles = pts.map(p => p.e);
  const eMin = Math.min(...eles) - 30;
  const eMax = Math.max(...eles) + 50;
  const mt = 30, mb = 0;

  const xScale = d => ((d - windowStart) / windowMiles) * W;
  const yScale = e => mt + (H - mt - mb) - ((e - eMin) / (eMax - eMin)) * (H - mt - mb);

  // Sky gradient
  const elapsed = (currentDist / TOTAL_MILES) * simFinishHours;
  const tod = RACE_START_HOUR + elapsed;
  let skyTop, skyBot;
  if (tod < 6) { skyTop = '#1a2030'; skyBot = '#252540'; }
  else if (tod < 8) { skyTop = '#2a3050'; skyBot = '#4a4070'; }
  else if (tod < 17) { skyTop = '#3a4560'; skyBot = '#5a6580'; }
  else if (tod < 20) { skyTop = '#3a3055'; skyBot = '#4a4070'; }
  else { skyTop = '#1a2030'; skyBot = '#252540'; }

  const skyGrad = ctx.createLinearGradient(0, 0, 0, H);
  skyGrad.addColorStop(0, skyTop);
  skyGrad.addColorStop(1, skyBot);
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, W, H);

  // Terrain fill
  ctx.beginPath();
  ctx.moveTo(xScale(pts[0].d), yScale(pts[0].e));
  for (const p of pts) ctx.lineTo(xScale(p.d), yScale(p.e));
  ctx.lineTo(xScale(pts[pts.length - 1].d), H);
  ctx.lineTo(xScale(pts[0].d), H);
  ctx.closePath();
  const tGrad = ctx.createLinearGradient(0, mt, 0, H);
  tGrad.addColorStop(0, 'rgba(46,125,50,0.3)');
  tGrad.addColorStop(1, 'rgba(46,125,50,0.05)');
  ctx.fillStyle = tGrad;
  ctx.fill();

  // Terrain line
  ctx.beginPath();
  ctx.moveTo(xScale(pts[0].d), yScale(pts[0].e));
  for (const p of pts) ctx.lineTo(xScale(p.d), yScale(p.e));
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 2.5;
  ctx.stroke();

  // Dim behind runner
  if (currentDist > windowStart) {
    ctx.fillStyle = 'rgba(26,32,48,0.4)';
    ctx.fillRect(0, 0, xScale(currentDist), H);
  }

  // Runner dot
  const rx = xScale(currentDist);
  const ry = yScale(currentEle);

  // Glow
  ctx.beginPath();
  ctx.arc(rx, ry, 12, 0, Math.PI * 2);
  const glow = ctx.createRadialGradient(rx, ry, 3, rx, ry, 12);
  glow.addColorStop(0, 'rgba(46,125,50,0.5)');
  glow.addColorStop(1, 'rgba(46,125,50,0)');
  ctx.fillStyle = glow;
  ctx.fill();

  ctx.beginPath();
  ctx.arc(rx, ry, 7, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();
  ctx.strokeStyle = '#2E7D32';
  ctx.lineWidth = 3;
  ctx.stroke();

  // Mile markers in view
  for (let m = Math.ceil(windowStart); m <= Math.floor(windowStart + windowMiles); m++) {
    if (m <= 0 || m >= TOTAL_MILES) continue;
    const mx = xScale(m);
    ctx.beginPath();
    ctx.moveTo(mx, mt);
    ctx.lineTo(mx, H);
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.font = '9px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(m + ' mi', mx, mt - 8);
  }
}

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════
initMap();
mapInitialized = true;
window.addEventListener('load', drawElevationProfile);
window.addEventListener('resize', () => {
  drawElevationProfile();
  if (currentView === 'sim') renderSim();
});
</script>
</body>
</html>